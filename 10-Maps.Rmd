# Основы картографии {#maps}

```{r setup-spatial, echo = FALSE, purl = FALSE, include=FALSE}
library(datasets)
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, collapse = TRUE, out.width = '100%')
```

## Предварительные требования {#maps_prerequisites}

Данный модуль посвящен введению в картграфические представления R. 

Необходимые для работы пакеты:
```{r}
library(sf)
library(stars)
library(raster)
library(mapview)
library(tidyverse)
```

## Визуализация средствами ggplot2 {#spatial_ggplot2}

Пространственные данные поддерживаются в графической подсистеме ggplot2. Для этого [существует](https://ggplot2.tidyverse.org/reference/ggsf.html) несколько специализированных функций:

- `geom_sf()` вызывает `stat_sf()` и `coord_sf()` того чтобы отобразить пространственные данные в нужной системе координат;
- `coord_sf()` обеспечивает поддержку картографических проекций и позволяет отображать данные в нужной системе координат на лету;
- `stat_sf()` отвечает за отображение переменных данных на графические переменные для пространственных данных;
- `geom_sf_label()` позволяет отображать подписи объектов на плашке;
- `geom_sf_text()` позволяет размещзать подписи объектов без плашки.


Отобразим для примера границы России в конической проекции:
```{r, eval=F}
russia = filter(countries, adm0_a3 == 'RUS')
ggplot(russia) +
  geom_sf() +
  geom_sf_label(aes(label = name)) +
  coord_sf(crs = '+proj=eqdc +lon_0=100 +lat_1=42 +lat_2=60 +datum=WGS84 +units=m') +
  scale_x_continuous(breaks = seq(-30, 180, by = 30))
```

Так же как ив случае стандартной подсистемы, можно указать атрибутивное поле, по которому будет строиться тематическая карта. Покажем это на примере выгруженных ранее Европейских стран:
```{r, eval=F}
brks = seq(0, 100, 10)
nbrks = length(brks)
ggplot(europe.conic) +
  geom_sf(aes(fill = 1000 * gdp_md_est/pop_est)) +
  scale_fill_gradientn(
      colours = RColorBrewer::brewer.pal(10, 'RdYlGn'), 
      breaks = brks,
      labels = paste(c(0, brks[-nbrks]), '-', brks),
      guide = guide_legend(keyheight = unit(0.5, "cm"), reverse = TRUE)
  ) +
  labs(title = 'Валовый внутренний продукт', fill = '\n$ тыс/чел.' )
```

## Интерактивные карты {#spatial_interactive}

R предоставляет возможности для интерактивного просмотра пространственных данных средствами библиотек веб-картографирования. В данном разделе мы кратко познакомимся с возможностями пакета [__mapview__](https://r-spatial.github.io/mapview/), который использует возможности библиотеки [Leaflet](https://leafletjs.com/). Функции данного пакета не предназначены для создания тематических карт высокого качества и рассчитаны на выполнение исследовательского анализа данных. 

Чтобы отобразить векторный или растровый слой средствами mapview, достаточно вызвать одноименную функцию данного пакета:
```{r, eval=FALSE}
mapview(sf_stations)
```

Чтобы скомбинировать несколько слоев, необходимо сложить несколько вызовов `mapview()`:
```{r, eval=FALSE}
mapview(countries, col.regions = 'white') + mapview(sf_stations, col.regions = 'red')
```

### Вопросы {#questions_maps}

1. Назовите пакет (и одноименную функцию), с помощью которых можно быстро осуществлять интерактивный просмотр пространственных данных.

----
_Самсонов Т.Е._ **Визуализация и анализ географических данных на языке R.** М.: Географический факультет МГУ, `r lubridate::year(Sys.Date())`. DOI: [10.5281/zenodo.901911](https://doi.org/10.5281/zenodo.901911)
----