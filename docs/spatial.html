<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Глава 10 Пространственные данные | Визуализация и анализ географических данных на языке R</title>
<meta name="author" content="Тимофей Самсонов">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9000/tabs.js"></script><script src="libs/bs3compat-0.2.4.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.17/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Визуализация и анализ географических данных на языке R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Введение</a></li>
<li class="book-part">Основы языка R</li>
<li><a class="" href="basics.html"><span class="header-section-number">1</span> Типы данных, условия, ввод и вывод</a></li>
<li><a class="" href="structures.html"><span class="header-section-number">2</span> Структуры данных и циклы</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">3</span> Табличные данные</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">4</span> Техники программирования</a></li>
<li class="book-part">Графика и статистика</li>
<li><a class="" href="graphics.html"><span class="header-section-number">5</span> Базовая графика</a></li>
<li><a class="" href="advgraphics.html"><span class="header-section-number">6</span> Продвинутая графика</a></li>
<li><a class="" href="stats.html"><span class="header-section-number">7</span> Основы статистики</a></li>
<li><a class="" href="temporal.html"><span class="header-section-number">8</span> Временные данные</a></li>
<li><a class="" href="circular.html"><span class="header-section-number">9</span> Дирекционные данные</a></li>
<li class="book-part">Пространственные данные</li>
<li><a class="active" href="spatial.html"><span class="header-section-number">10</span> Пространственные данные</a></li>
<li><a class="" href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></li>
<li><a class="" href="three.html"><span class="header-section-number">12</span> Трехмерные модели</a></li>
<li><a class="" href="vector.html"><span class="header-section-number">13</span> Векторный анализ</a></li>
<li><a class="" href="network.html"><span class="header-section-number">14</span> Cетевой анализ</a></li>
<li><a class="" href="raster.html"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="" href="interp.html"><span class="header-section-number">16</span> Интерполяция геополей</a></li>
<li class="book-part">Пространственная статистика</li>
<li><a class="" href="gstat.html"><span class="header-section-number">17</span> Геостатистика</a></li>
<li><a class="" href="spreg.html"><span class="header-section-number">18</span> Пространственная регрессия</a></li>
<li><a class="" href="gwr.html"><span class="header-section-number">19</span> Географически взвешенная регрессия</a></li>
<li><a class="" href="points.html"><span class="header-section-number">20</span> Точечные процессы</a></li>
<li class="book-part">Решение проблем</li>
<li><a class="" href="package-troubles.html"><span class="header-section-number">A</span> Установка пакетов</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tsamsonov/r-geo-course">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatial" class="section level1" number="10">
<h1>
<span class="header-section-number">Глава 10</span> Пространственные данные<a class="anchor" aria-label="anchor" href="#spatial"><i class="fas fa-link"></i></a>
</h1>
<div id="spatial_prerequisites" class="section level2" number="10.1">
<h2>
<span class="header-section-number">10.1</span> Предварительные требования<a class="anchor" aria-label="anchor" href="#spatial_prerequisites"><i class="fas fa-link"></i></a>
</h2>
<p>Данный модуль посвящен введению в работу с пространственными данными в R. Рассмотрены общие вопросы моделирования реального мира средствами моделей пространственных данных. Рассматривается чтение векторных и растровых данных, их визуализация стандартными средствами.</p>
<p>Необходимые для работы пакеты:</p>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="spatial_models" class="section level2" number="10.2">
<h2>
<span class="header-section-number">10.2</span> Модели пространственных данных<a class="anchor" aria-label="anchor" href="#spatial_models"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Пространственные данные</strong> — это данные о пространственных объектах и их наборах. В свою очередь, пространственный объект определяется как <em>цифровая модель материального или абстрактного объекта реального или виртуального мира с указанием его идентификатора, координатных и атрибутивных данных</em>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;ГОСТ Р 52438-2005 &amp;lt;&amp;lt;Географические информационные системы. Термины и определения&amp;gt;&amp;gt;. В стандарте поясняется, что объектом может быть неподвижный или движущийся простой или сложный объект, явление, событие, процесс и ситуация. Моделируемый объект может относиться к территории, акватории, недрам и воздушному пространству Земли, околоземному космическому пространству, другим космическим телам и небесной сфере. В широком смысле под пространственным объектом в геоинформатике понимается как сам объект, так и адекватная ему цифровая модель&lt;/p&gt;"><sup>6</sup></a></p>
<p>Если говорить по сути, то пространственные данные можно определить как <em>данные о географических объектах или явлениях, фиксирующие их местоположение и/или распределение в системе координат, привязанной к телу Земли или любого другого небесного тела</em>. Таким образом, отличительной особенностью пространственных данных перед непространственными является координатное описание местоположения. Важно знать отличия между векторной и растровой моделью пространственных данных.</p>
<p><strong>Векторная модель</strong> пространственных данных включает описание координатных данных пространственных объектов и, возможно, топологических отношений между ними. Векторные данные фиксируют местоположение и форму объектов в виде геометрических примитивов, таких как точки, линии, полигоны, объемные тела. Выбор модели объекта (например, представить город точкой или полигоном) зависит от масштаба анализа и целей исследования. Векторная модель данных является объектно-ориентированной.</p>
<p><strong>Растровая модель</strong> описывает не объекты, а пространственное распределение некоторой (выбранной исследователем) характеристики. Пространство разбивается регулярной сеткой ячеек, в каждой ячейке фиксируется значение исследуемого параметра (путем статистического осреднения, семплирования в центре ячейки и т.п.). Растровые данные могут быть как количественными (например, поле температуры), так и качественными (например, растр классифицированного снимка, каждая ячейка которого фиксирует принадлежность к тому или иному типу объекта). Таким образом, растровая модель является пространственно-ориентированной (или феномен-ориентированной).</p>
<p>Существуют и другие модели пространственных данных, однако их рассмотрение выходит за рамки настоящей лекции.</p>
<p>В настоящей лекции мы познакомимся с чтением и визуализацией пространственных данных в векторном и растровом формате, а также рассмотрим вопросы связанные с использованием картографических проекций.</p>
<div id="simple_features" class="section level3" number="10.2.1">
<h3>
<span class="header-section-number">10.2.1</span> Векторные данные<a class="anchor" aria-label="anchor" href="#simple_features"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Simple Features</strong> (официально <em>Simple Features Access</em>) — это стандарт <a href="http://www.opengeospatial.org/standards/sfa">OGC 06-103</a>, разработанный Open Geospatial Consortium (OGC) и реализованный также в виде международного стандарта <a href="https://www.iso.org/standard/40114.html">ISO 19125</a>, который определяет общую модель хранения и доступа к векторным объектам (точка, линия, многоугольник, мульти точечные, мультилинии и т. д.), в географических информационных системах.</p>
<p>Геометрическое представление пространственных объектов базируется на следующих принципах:</p>
<ul>
<li>Все геометрии состоят из точек.</li>
<li>Точки являются координатами в 2-, 3- или 4-мерном пространстве.</li>
<li>Все точки в геометрии имеют одинаковую размерность.</li>
</ul>
<p>В дополнение к координатам <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span> имеются два дополнительных дополнительных параметра:</p>
<ul>
<li>координата <span class="math inline">\(Z\)</span>, обозначающая высоту</li>
<li>координата <span class="math inline">\(M\)</span>, обозначающая некоторую меру, связанную с точкой, а не с признаком в целом (в этом случае это будет атрибут объекта).
Измерение <span class="math inline">\(M\)</span> может быть использовано, например, для представления времени или линейных координат (для маршрутов).</li>
</ul>
<p>Координаты простой геометрии всегда содержат компоненты <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span>, поэтому все разнообразие возможных представлений определяется наличием или отсутствием дополнительных измерений <span class="math inline">\(Z\)</span> и <span class="math inline">\(M\)</span> Таким образом, получаем <strong>четыре</strong> варианта геометрии:</p>
<ul>
<li>двумерные точки <span class="math inline">\(XY\)</span>
</li>
<li>трехмерные точки <span class="math inline">\(XYZ\)</span>
</li>
<li>трехмерные точки <span class="math inline">\(XYM\)</span>
</li>
<li>четырехмерные точки <span class="math inline">\(XYZM\)</span>
</li>
</ul>
<p>В случае использования широт и долгот <span class="math inline">\(X\)</span> соответствует долготе, <span class="math inline">\(Y\)</span> соответствует широте.</p>
<p>Всего стандарт <strong>Simple Features</strong> включает в себя 17 типов геометрий. Из них наиболее употребительными являются следующие 7:</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="4%">
<col width="95%">
</colgroup>
<thead><tr class="header">
<th>Тип</th>
<th>Описание</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>POINT</code></td>
<td>нуль-мерная геометрия, содержащая одну точку</td>
</tr>
<tr class="even">
<td><code>LINESTRING</code></td>
<td>последовательность точек, соединенных прямыми, несамопересекающимися отрезками; одномерная геометрия</td>
</tr>
<tr class="odd">
<td><code>POLYGON</code></td>
<td>геометрия с положительной площадью (двумерная); последовательность точек, отрезки между которыми формируют замкнутое кольцо без самопересечений; первое кольцо является внешним, ноль и более остальных колец представляют дырки внутри полигона</td>
</tr>
<tr class="even">
<td><code>MULTIPOINT</code></td>
<td>множество точек; геометрия типа <code>MULTIPOINT</code> называется <em>простой</em> если ни одна пара точек в <code>MULTIPOINT</code> не совпадает</td>
</tr>
<tr class="odd">
<td><code>MULTILINESTRING</code></td>
<td>множество линий</td>
</tr>
<tr class="even">
<td><code>MULTIPOLYGON</code></td>
<td>множество полигонов</td>
</tr>
<tr class="odd">
<td><code>GEOMETRYCOLLECTION</code></td>
<td>множество геометрий произвольного типа за исключением <code>GEOMETRYCOLLECTION</code>
</td>
</tr>
</tbody>
</table></div>
<p>Примеры различных видов геометрий представлены на рисунке ниже:</p>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-3-1.png" width="100%"></div>
<p>Оставшиеся виды геометрий <em>Simple Features</em> включают: <code>CIRCULARSTRING</code>, <code>COMPOUNDCURVE</code>, <code>CURVEPOLYGON</code>, <code>MULTICURVE</code>, <code>MULTISURFACE</code>, <code>CURVE</code>, <code>SURFACE</code>, <code>POLYHEDRALSURFACE</code>, <code>TIN</code>, <code>TRIANGLE</code>.</p>
<p>Существует два официально закрепленных формата представления SF: <em>Well-Known Text (WKT)</em> и <em>Well-Known Binary (WKB)</em>, которые необходимы для чтения таких данных человеком и машиной соответственно.</p>
<p><strong>Well-Known Text (WKT)</strong> — стандарт представления геометрии в виде множества списков координат, в которых координаты вершин разделены пробелами, вершины разделены запятыми, а компоненты полигонов и мультигеометрий заключены в круглые скобки и также разделены запятыми. Вышеприведенной картинке соответствуют следующие строки <em>WKT</em>:</p>
<pre><code>## MULTIPOINT ((3.2 4), (3 4.6), (3.8 4.4), (3.5 3.8), (3.4 3.6), (3.9 4.5))
## LINESTRING (0 3, 0 4, 1 5, 2 5)
## MULTILINESTRING ((0 3, 0 4, 1 5, 2 5), (0.2 3, 0.2 4, 1 4.8, 2 4.8), (0 4.4, 0.6 5))
## POLYGON ((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1))
## MULTIPOLYGON (((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3)))
## GEOMETRYCOLLECTION (MULTIPOINT ((3.2 4), (3 4.6), (3.8 4.4), (3.5 3.8), (3.4 3.6), (3.9 4.5)), MULTIPOLYGON (((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3))), LINESTRING (0 3, 0 4, 1 5, 2 5))</code></pre>
<p><strong>Well-Known Binary (WKB)</strong> — бинарный формат хранения координат. Именно этот формат фактически используется в базах данных, поскольку он обеспечивает высокую скорость чтения и записи данных (в отличие от текстового). Однако внешний вид данных в формате WKB мало о чем говорит человеку, поскольку он предназначен для чтения компьютером. Например, вышеприведенная строка <code>LINESTRING</code> будет выглядеть так:</p>
<pre><code>## 01 02 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 08 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 10 40 00 00 00 00 00 00 f0 3f 00 00 00 00 00 00 14 40 00 00 00 00 00 00 00 40 00 00 00 00 00 00 14 40</code></pre>
</div>
<div id="raster_data" class="section level3" number="10.2.2">
<h3>
<span class="header-section-number">10.2.2</span> Растровые данные<a class="anchor" aria-label="anchor" href="#raster_data"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Растр</strong> представляет из себя матрицу значений. Каждой ячейке матрицы соответствует прямоугольная пространственная область фиксированного размера, которая называется <em>пикселом</em>. Различают растры <em>непрерывные</em> и <em>категориальные (классифицированные)</em>. Также необходимо разделять <em>одноканальные</em> и <em>многоканальные растры</em>. Примером одноканального растра является цифровая модель рельефа. В виде многоканальных растров часто представляют космические снимки.</p>
<p>В отличие от векторных данных, которые требуют указания координат для каждой вершины, регулярно-ячеистый характер растровой модели позволяет вычислять координаты пикселов на основе их индексов. Поэтому фактически растровые данные хранятся в виде линейно упорядоченного списка значений <em>(raster values)</em> и описания геометрии растра <em>(raster geometry)</em>.</p>
<p><strong>Геометрия растра</strong> определяет, где именно располагаются в пространстве пикселы растра и может быть описана путем указания следующих компонент<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Названия перечисленных компонент геометрии растра укоренились благодаря распространенности стандарта &lt;a href="https://en.wikipedia.org/wiki/Esri_grid"&gt;Esri ASCII Grid&lt;/a&gt;&lt;/p&gt;'><sup>7</sup></a>:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>Параметр</th>
<th>Назначение</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>NCOLS</code></td>
<td>Количество столбцов</td>
</tr>
<tr class="even">
<td><code>NROWS</code></td>
<td>Количество строк</td>
</tr>
<tr class="odd">
<td><code>XLLCENTER</code></td>
<td>Координата <span class="math inline">\(X\)</span> центра левой нижней ячейки растра</td>
</tr>
<tr class="even">
<td><code>YLLCENTER</code></td>
<td>Координата <span class="math inline">\(Y\)</span> центра левой нижней ячейки растра</td>
</tr>
<tr class="odd">
<td><code>CELLSIZE</code></td>
<td>Размер ячейки</td>
</tr>
</tbody>
</table></div>
<p>Иногда вместо параметров <code>XLLCENTER</code>/<code>YLLCENTER</code> указываются <code>XLLCORNER</code>/<code>YLLCORNER</code>, которые кодируют координаты левого нижнего угла, а не центра левой нижней ячейки растра. Выбор одного из двух этих вариантов определяет тип <em>регистрации растра</em>, а их значения указывают, в какое именно место необходимо “посадить” растр, чтобы его ячейки заняли соответствующие им области в системе координат. Если геометрия растра характеризуется <em>анизотропией</em>, то вместо одного значения <code>CELLSIZE</code> могут быть указаны разные размеры ячеек по осям координат <code>CELLSIZEX</code> и <code>CELLSIZEY</code>.</p>
<p>В отличие от векторной модели, которая позволяет хранить данные только о нужных географических локациях, растровая модель такой свободы не предоставляет. Матрица ячеек растра всегда покрывает область данных целиком, и за простоту растровой структуры приходится расплачиваться ее неэкономичностью. Поскольку часто данные имеются не на всю территорию, возникает необходимость кодирования ячеек, для которых данные не известны, специальным числом (назовем его условно <code>NODATA_VALUE</code>). Значение этого числа хранится в метаданных растра и позволяет интерпретировать соответствующие ячейки как пустые.</p>
</div>
</div>
<div id="spatref" class="section level2" number="10.3">
<h2>
<span class="header-section-number">10.3</span> Пространственная привязка<a class="anchor" aria-label="anchor" href="#spatref"><i class="fas fa-link"></i></a>
</h2>
<div id="spatref_components" class="section level3" number="10.3.1">
<h3>
<span class="header-section-number">10.3.1</span> Компоненты пространственной привязки<a class="anchor" aria-label="anchor" href="#spatref_components"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Пространственная привязка</strong> (<em>spatial reference</em> или <em>georeference</em>) — важнейшая составляющая пространственных данных, которая говорит нам о том, как правильно интерпретировать координаты объектов. Пространственная привязка в простейшем случае включает несколько фундаментальных компонент:</p>
<ol style="list-style-type: decimal">
<li>
<em>Эллипсоид вращения</em> — тело, по отношению к которому вычисляются геодезические координаты точек (широты и долготы)</li>
<li>
<em>Исходные геодезические даты (датум)</em> — параметры положения эллипсоида в теле Земли</li>
<li>
<em>Географическая система координат</em> — включает датум, положение начального меридиана и единицы измерения широт и долгот</li>
<li>
<em>Проекция</em> — математический способ перехода от географических координат на эллипсоиде к плоским прямоугольным координатам карты.</li>
<li>
<em>Плоская прямоугольная система координат</em> — включает проекцию, ее параметры и единицы измерения координат.</li>
</ol>
<p>Если точки имеют также координаты <span class="math inline">\(Z\)</span>, то для их правильной интерпретации необходимы дополнительные компоненты пространственной привязки:</p>
<ol style="list-style-type: decimal">
<li>
<em>Система счета высот</em> (геодезические, нормальные, ортометрические) - определяют содержательный смысл и порядок вычисления высот и глубин (координата Z)</li>
<li>
<em>Модель геоида, квазигеоида или эллипсоида</em> — определяет поверхность, относительно которой вычисляются высоты точек.</li>
<li>
<em>Вертикальная система координат</em> — фактическая реализация системы счета высот относительно конкретной поверхности относимости с заданным положением нулевого уровня. Например, в России это <em>Балтийская система нормальных высот</em> с нулем в г. Кронштадт.</li>
</ol>
<p>Аналогичным образом требуется введение системы счета дополнительных координат <span class="math inline">\(M\)</span>, если они используются в представлении координат.</p>
</div>
<div id="spatref_formats" class="section level3" number="10.3.2">
<h3>
<span class="header-section-number">10.3.2</span> Форматы описания пространственной привязки<a class="anchor" aria-label="anchor" href="#spatref_formats"><i class="fas fa-link"></i></a>
</h3>
<p>Существует три распространенных способа задания (хранения) пространственной привязки:</p>
<ul>
<li>
<em>PROJ.4 String</em> — представление в виде строки.</li>
<li>
<em>WKT (Well-Known Text)</em> — представление в виде иерархического списка.</li>
<li>
<em>EPSG (European Petroleum Survey Group)</em> — представление в виде числового кода.</li>
</ul>
<p>Для поиска проекций в перечисленных форматах представления удобно воспользоваться порталом <a href="spatialreference.org">spatialreference.org</a>.</p>
<p><strong>PROJ.4 String</strong> — строковый формат представления информации о пространственной привязки, используемый в библиотеке <a href="http://proj4.org">PROJ.4</a>. Данная библиотека лежит в основе координатных систем пространственных данных, используется в <strong>R</strong>, <strong>Python</strong>, <strong>QGIS</strong> и прочих средах. Основные параметры строки:</p>
<pre><code>+datum     Datum name (see `proj -ld`)
+ellps     Ellipsoid name (see `proj -le`)
+lat_0     Latitude of origin
+lat_1     Latitude of first standard parallel
+lat_2     Latitude of second standard parallel
+lat_ts    Latitude of true scale
+lon_0     Central meridian
+proj      Projection name (see `proj -l`)
+units     meters, US survey feet, etc.
+vunits    vertical units.
+x_0       False easting
+y_0       False northing
+zone      UTM zone</code></pre>
<p>Примеры записи координат в формате PROJ.4:</p>
<ul>
<li><p>Географические координаты в <em>WGS84</em> (без проекции):</p></li>
<li><p>Координаты в проекции <em>Web Mercator</em> (проекция Google Maps, Яндекс.Карт и т.д.):</p></li>
<li><p>Координаты в <em>конической равнопромежуточной проекции</em>:</p></li>
<li><p>Координаты в проекции <em>UTM, зона 37</em>:</p></li>
</ul>
<p>Запись координат в формате WKT предполагает представление вышеуказанных компонент пространственной привязки к виде иерархического списка. Например, так будет выглядеть информация о <em>полярной стереографической проекции для карт России</em>:</p>
<pre><code>PROJCS["WGS 84 / EPSG Russia Polar Stereographic",
    GEOGCS["WGS 84",
        DATUM["WGS_1984",
            SPHEROID["WGS 84",6378137,298.257223563,
                AUTHORITY["EPSG","7030"]],
            AUTHORITY["EPSG","6326"]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4326"]],
    PROJECTION["Polar_Stereographic"],
    PARAMETER["latitude_of_origin",90],
    PARAMETER["central_meridian",105],
    PARAMETER["scale_factor",0.994],
    PARAMETER["false_easting",2000000],
    PARAMETER["false_northing",2000000],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["X",EAST],
    AXIS["Y",NORTH],
    AUTHORITY["EPSG","5940"]]</code></pre>
<p><strong>EPSG (European Petroleum Survey Group)</strong> — европейская рабочая группа нефтегазовой области, которая ведет реестр систем координат с уникальными цифровыми кодами вида <code>EPSG:xxxxxx</code>. Коды EPSG оказались настолько удобны, что используются повсеместно для быстрой инициализации проекций со стандартными параметрами. Например, вышеприведенные проекции имеют следующие коды EPSG:</p>
<ul>
<li>
<em>WGS84</em>: <code>EPSG:4326</code>
</li>
<li>
<em>Web Mercator</em>: <code>EPSG:3857</code>
</li>
<li>
<em>UTM</em>: <code>EPSG:326..</code> , например для UTM 37N: <code>EPSG:32637</code>
</li>
</ul>
</div>
<div id="spatref_transform" class="section level3" number="10.3.3">
<h3>
<span class="header-section-number">10.3.3</span> Преобразование координат<a class="anchor" aria-label="anchor" href="#spatref_transform"><i class="fas fa-link"></i></a>
</h3>
<p>Преобразование координат включает три различных операции:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Трансформирование</strong> — пересчет географических координат с одного датума на другой</p></li>
<li><p><strong>Проецирование</strong> — переход от географических координат к плоским прямоугольным</p></li>
<li><p><strong>Обратное проецирование</strong> — переход от плоских координат к географическим.</p></li>
</ol>
<p>Например, чтобы пересчитать координаты <em>UTM</em> в проекцию <em>Гаусса-Крюгера</em>, необходимо:</p>
<ol style="list-style-type: decimal">
<li>Обратно проецировать координаты в географические <em>WGS84</em>
</li>
<li>Трансформировать географические координаты c <em>WGS84</em> в <em>ГСК-2011</em>
</li>
<li>Проецировать координаты <em>ГСК-2011</em> в проекцию <em>Гаусса-Крюгера</em>
</li>
</ol>
<p><em>Несоответствие датумов часто является причиной того, что данные из разных наборов плохо совмещаются друг с другом</em></p>
</div>
</div>
<div id="vector_data_r" class="section level2" number="10.4">
<h2>
<span class="header-section-number">10.4</span> Векторные данные<a class="anchor" aria-label="anchor" href="#vector_data_r"><i class="fas fa-link"></i></a>
</h2>
<div id="vector_data_packages" class="section level3" number="10.4.1">
<h3>
<span class="header-section-number">10.4.1</span> Базовые библиотеки<a class="anchor" aria-label="anchor" href="#vector_data_packages"><i class="fas fa-link"></i></a>
</h3>
<p>В R существует высоко развитая инфраструктура для работы с векторными данными, которая обеспечивается пакетом <a href="https://cran.r-project.org/web/packages/sf/index.html">sf</a>. Этот пакет появился совсем недавно (в 2016 году). Ранее поддержка пространственных данных обеспечивалась пакетом <a href="https://cran.r-project.org/web/packages/sp/index.html">sp</a>, который по прежнему активно используется, и на который “завязано” множество других библиотек. Существующая в настоящий момент инфраструктура кратко показана ниже:</p>
<div class="figure">
<img src="images/sf_architecture.png" alt=""><p class="caption">Архитектура программных библиотек для работы с пространственными данными в R</p>
</div>
<p>Исторический пакет <code>sp</code> обеспечивал (и продолжает обеспечивать) поддержку пространственных данных в виде специальных классов данных типа <code>Spatial</code>, реализуя классы как для чисто геометрических объектов (<code>SpatialPolygons</code>), так и для пространственных объектов с атрибутами (<code>SpatialPolygonsDataFrame</code>). Во втором случае набор объектов имеет ассоциированную с ним таблицу атрибутов. С классами типа <code>Spatial</code> существуют несколько проблем. Во-первых, они не являются объектами типа <code>data.frame</code> (не расширяют их), а являются самостоятельным классом объектов, поэтому к ним часто невозможно корректно применить стандартные операции трансформации таблиц (типа тех, что доступны в пакете <strong>dplyr</strong>). Во-вторых, объекты типа <code>Spatial</code> не реализуют существующие стандарты представления пространственных данных (типа <em>Simple Features</em>), что накладывает ограничения на их интероперабельность с современными форматами данных (например, <a href="http://www.geopackage.org">GeoPackage</a>).</p>
<p>Пакет <a href="https://cran.r-project.org/web/packages/sf/index.html">sf</a> решает все эти проблемы. Множество функций, которые были раньше разбросаны по нескольким пакетам <strong>R</strong> (sp, rgdal, rgeos), теперь доступны в одном интерфейсе:</p>
<div class="sourceCode" id="cb438"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="co"># Посмотрим, какие методы доступных для объектов класса sf</span>
<span class="co">##   [1] [                     [[&lt;-                  $&lt;-                  </span>
<span class="co">##   [4] aggregate             anti_join             arrange              </span>
<span class="co">##   [7] as.data.frame         cbind                 coerce               </span>
<span class="co">##  [10] dbDataType            dbWriteTable          distinct             </span>
<span class="co">##  [13] dplyr_reconstruct     extent                extract              </span>
<span class="co">##  [16] filter                full_join             gather               </span>
<span class="co">##  [19] group_by              group_split           identify             </span>
<span class="co">##  [22] initialize            inner_join            left_join            </span>
<span class="co">##  [25] mapView               mask                  merge                </span>
<span class="co">##  [28] mutate                nest                  plot                 </span>
<span class="co">##  [31] print                 raster                rasterize            </span>
<span class="co">##  [34] rbind                 rename                right_join           </span>
<span class="co">##  [37] rowwise               sample_frac           sample_n             </span>
<span class="co">##  [40] select                semi_join             separate_rows        </span>
<span class="co">##  [43] separate              show                  slice                </span>
<span class="co">##  [46] slotsFromS3           spread                st_agr               </span>
<span class="co">##  [49] st_agr&lt;-              st_area               st_as_s2             </span>
<span class="co">##  [52] st_as_sf              st_as_stars           st_bbox              </span>
<span class="co">##  [55] st_boundary           st_buffer             st_cast              </span>
<span class="co">##  [58] st_centroid           st_collection_extract st_convex_hull       </span>
<span class="co">##  [61] st_coordinates        st_crop               st_crs               </span>
<span class="co">##  [64] st_crs&lt;-              st_difference         st_filter            </span>
<span class="co">##  [67] st_geometry           st_geometry&lt;-         st_interpolate_aw    </span>
<span class="co">##  [70] st_intersection       st_intersects         st_is_valid          </span>
<span class="co">##  [73] st_is                 st_join               st_line_merge        </span>
<span class="co">##  [76] st_m_range            st_make_valid         st_nearest_points    </span>
<span class="co">##  [79] st_node               st_normalize          st_point_on_surface  </span>
<span class="co">##  [82] st_polygonize         st_precision          st_reverse           </span>
<span class="co">##  [85] st_sample             st_segmentize         st_set_precision     </span>
<span class="co">##  [88] st_shift_longitude    st_simplify           st_snap              </span>
<span class="co">##  [91] st_sym_difference     st_transform_proj     st_transform         </span>
<span class="co">##  [94] st_triangulate        st_union              st_voronoi           </span>
<span class="co">##  [97] st_wrap_dateline      st_write              st_z_range           </span>
<span class="co">## [100] st_zm                 summarise             transform            </span>
<span class="co">## [103] transmute             ungroup               unite                </span>
<span class="co">## [106] unnest               </span>
<span class="co">## see '?methods' for accessing help and source code</span></code></pre></div>
<p>Со многими из этих функций мы познакомимся в последующих разделах нашего курса. Некоторые из них (такие как <code>arrange</code>, <code>filter</code>, <code>mutate</code> из пакета <strong>dplyr</strong>), должны быть уже знакомы вам по предыдущим лекциям. Можно обратить внимание на то, что практически все функции начинаются с префикса <code>st_</code>, что означает <strong>“spatiotemporal”</strong>. Данные префиксы были выбраны для унификации с аналогичными названиями функций, используемых в широко распространенной СУБД PostgreSQL для оперирования объектами Simple Features.</p>
</div>
<div id="vector_data_reading" class="section level3" number="10.4.2">
<h3>
<span class="header-section-number">10.4.2</span> Чтение<a class="anchor" aria-label="anchor" href="#vector_data_reading"><i class="fas fa-link"></i></a>
</h3>
<p>Существует большое множество форматов хранения пространственных данных. Но в общем и целом их можно разделить на две категории: файловые форматы (наиболее привычные пользователям) и хранение данных в СУБД — системах управления базами данных. Благодаря библиотеке GDAL пакет <strong>sf</strong> имеет возможность читать и записывать <a href="http://www.gdal.org/ogr_formats.html">более 90 различных форматов векторных даных</a>.</p>
<p>Исторически наиболее распространенным форматом был (и остается) <a href="https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf">ESRI Shapefile</a>. Данный формат, однако не отвечает современным техническим требованиям с точки зрения гибкости, соответствия стандартам и возможностям хранения разнообразных типов геометрий (напомним, что в стандарте <strong>Simple Features</strong> их 17, а с учетом четырех вариантов размерности точек получается целых 68 ). Современный формат, который обеспечивает полную поддержку стандарта <strong>Simple Features</strong> (и не только) — это <a href="http://www.geopackage.org">GeoPackage</a>. Именно его мы и будем использовать в нашем практикуме.</p>
<p>Для чтения данных средствами sf необходимо использовать функцию <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read()</a></code>:</p>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">countries</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/ne/countries.gpkg'</span><span class="op">)</span>
<span class="co">## Reading layer `admin_0_map_units' from data source `/Users/tsamsonov/GitHub/r-geo-course/data/ne/countries.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 183 features and 72 fields</span>
<span class="co">## geometry type:  MULTIPOLYGON</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span>
<span class="co">## geographic CRS: WGS 84</span></code></pre></div>
<p>Лог функции сообщил нам следующую информацию:</p>
<ul>
<li>Набор данных представляет собой коллекцию из 183 пространственных объектов с 72 атрибутами</li>
<li>Тип геометрии <code>MULTIPOLYGON</code>
</li>
<li>Размерность геометрии <span class="math inline">\(XY\)</span>
</li>
<li>Ограничивающий прямоугольник (разброс координат) по осям <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span> имеет диапазон <span class="math inline">\([-180, 180] \times [-90, 83.64513]\)</span>
</li>
<li>EPSG-код пространственной привязки равен <code>4326</code>
</li>
<li>PROJ.4-строка пространственной привязки равна <code>+proj=longlat +datum=WGS84 +no_defs</code>
</li>
</ul>
</div>
<div id="sf_structure" class="section level3" number="10.4.3">
<h3>
<span class="header-section-number">10.4.3</span> Внутренняя структура<a class="anchor" aria-label="anchor" href="#sf_structure"><i class="fas fa-link"></i></a>
</h3>
<p>Традиционно во всех ГИС-приложениях и базах пространственных данных множество пространственных объектов представляется в виде таблицы атрибутов, где каждая строка соответствует объекту, а каждый столбец — атрибуту объекта. С каждой строкой таблицы должна быть ассоциирована информация о геометрии объекта, которая, в зависимости от формата данных, может либо храниться непосредственно в таблице (в специальном столбце), либо быть вынесена в отдельную структуру данных, которая связана с таблицей атрибутов посредством ключа<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Например, в широко распространенном формате &lt;strong&gt;Esri Shapefile&lt;/strong&gt; атрибутивная таблица хранится в файле &lt;code&gt;*.dbf&lt;/code&gt; формата &lt;em&gt;DBASE&lt;/em&gt;, геометрия хранится в отдельном файле &lt;code&gt;*.shp&lt;/code&gt;, а связь между ними осуществляется через файл &lt;code&gt;*.shx&lt;/code&gt;. Разбиение формата хранения на несколько файлов — это одна из уязвимостей шейп-файлов: при отсутствии хотя бы одного из этих файлов данные прочесть стандартными средствами (без дополнительного хакинга) будет нельзя.&lt;/p&gt;"><sup>8</sup></a>.</p>
<p>В <strong>R</strong> используется первый подход, в котором информация о геометрии хранится в специальном столбце таблицы. Каждая ячейка этого столбца соответствует геометрическому объекту <em>Simple Features</em>. Представление геометрических объектов реализовано стандартными средствами, такими как списки, матрицы и векторы. Эти структуры данных упорядоченным образом хранят координаты объектов и естественным образом соответствуют способу организации данных, который регламентируется стандартом <em>Simple Features</em>. Поскольку геометрический столбец хранит не обычные переменные, а структуры данных, он реализуется в виде так называемого <em>списка-колонки (list-column)</em>, каждый элемент которой соответствует отдельному объекту.</p>
<p>Исходя из этих соображений, представление пространственных объектов реализовано в <strong>R</strong> в виде иерархии из трех классов объектов:</p>
<ol style="list-style-type: decimal">
<li>
<code>sf</code> (simple features) — объект класса <code>data.frame</code>, представляющий множество пространственных объектов со списком-колонкой для хранения геометрии</li>
<li>
<code>sfc</code> (simple features geometry column) — список-колонка в объекте <code>sf</code>, представляющий множество геометрий пространственных объектов</li>
<li>
<code>sfg</code> (simple feature geometry) — геометрия пространственного объекта внутри списка <code>sfc</code>
</li>
</ol>
<p>В соответствии с перечисленными спецификациями происходит работа с пространственными объектами. То что, объекты типа Simple Features реализованы в виде самых обычных фреймов данных, означает что <em>любая операция, применимая к фрейму данных, будет также применима к объекту типа</em> <code>sf</code>. Это очень важная особенность объектов типа sf, которой сильно не хватало в экосистеме исторического пакета <code>sp</code>.</p>
<p>Посмотрим, как все это реализовано, на конкретном примере:</p>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>
<span class="co">## [1] "sf"         "data.frame"</span></code></pre></div>
<p>Данная форма записи говорит о том, что прочитанный слой имеет класс <em>sf</em>, который, в свою очередь, является расширением класса <em>data.frame</em>.</p>
<p>А теперь посмотрим на последние колонки в первых строках таблицы:</p>
<div class="sourceCode" id="cb441"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">countries</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">## Simple feature collection with 6 features and 5 fields</span>
<span class="co">## geometry type:  MULTIPOLYGON</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="co">##   tiny homepart min_zoom min_label max_label                       geometry</span>
<span class="co">## 1  -99        1        0         3         7 MULTIPOLYGON (((61.21082 35...</span>
<span class="co">## 2  -99        1        0         3         7 MULTIPOLYGON (((23.90415 -1...</span>
<span class="co">## 3  -99        1        0         5        10 MULTIPOLYGON (((21.02004 40...</span>
<span class="co">## 4  -99        1        0         4         9 MULTIPOLYGON (((51.57952 24...</span>
<span class="co">## 5  -99        1        0         2         7 MULTIPOLYGON (((-66.95992 -...</span>
<span class="co">## 6  -99        1        0         5        10 MULTIPOLYGON (((43.58275 41...</span></code></pre></div>
<p>Видно, что геометрия пространственных объектов хранится в заключительном столбце с названием <code>geometry</code>. Данный столбец можно быстро извлечь, применив функцию <code><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry()</a></code>. Полученный объект будет иметь тип <strong>sfc</strong> (Simple Feature Geometry Column)</p>
<div class="sourceCode" id="cb442"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">outlines</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">outlines</span><span class="op">)</span>
<span class="co">## [1] "sfc_MULTIPOLYGON" "sfc"</span></code></pre></div>
<p>Полученный вывод говорит нам о том, что наши объекты имеют класс <code>sfc_MULTIPOLYGON</code>, который является расширением класса <code>sfc</code> (simple feature geometry column).</p>
<p>Теперь если просмотреть начало данных, то мы увидим, что это больше не фрейм данных, а аннотированный список:</p>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">outlines</span><span class="op">)</span>
<span class="co">## Geometry set for 6 features </span>
<span class="co">## geometry type:  MULTIPOLYGON</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="co">## First 5 geometries:</span></code></pre></div>
<p>Далее можно опуститься на базовый уровень геометрии, получив доступ к отдельному объекту. Поскольку объект класса <code>sfc</code> представляет собой список, любой элемент можно извлечь по его порядковому номеру. Класс полученного объекта будет:</p>
<div class="sourceCode" id="cb444"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">outlines</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">## [1] "XY"           "MULTIPOLYGON" "sfg"</span></code></pre></div>
<p>Исходя из полученной информации можно сделать вывод, что геометрия 8-го объекта таблицы <code>countries</code> имеет класс <code>sfg</code>, реализованный в виде мультиполигонов (<code>MULTIPOLYGON</code>) с плоскими координатами (<code>XY</code>)</p>
<p>Наконец, чтобы добраться до координат в чистом виде, необходимо развернуть иерархию списков, из которых состоит объект <code>sfg</code>. Количество уровней вложенности всегда зависит от конкретного объекта, их может быть достаточно много, особенно если объекты представлены мультиполигонами (несколько компонент связности), каждый из которых также состоит из полигонов с дырками. В нашем случае все достаточно просто, так как в слое <code>countries</code> дырок в полигонах нет, а 8-й по счету полигон состоит из одной-единственной геометрии, координаты которой в виде матрицы можно извлечь как:</p>
<div class="sourceCode" id="cb445"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">outlines</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="co">## [[1]]</span>
<span class="co">##          [,1]     [,2]</span>
<span class="co">##  [1,] 68.9350 -48.6250</span>
<span class="co">##  [2,] 69.5800 -48.9400</span>
<span class="co">##  [3,] 70.5250 -49.0650</span>
<span class="co">##  [4,] 70.5600 -49.2550</span>
<span class="co">##  [5,] 70.2800 -49.7100</span>
<span class="co">##  [6,] 68.7450 -49.7750</span>
<span class="co">##  [7,] 68.7200 -49.2425</span>
<span class="co">##  [8,] 68.8675 -48.8300</span>
<span class="co">##  [9,] 68.9350 -48.6250</span></code></pre></div>
</div>
<div id="sf_plotting" class="section level3" number="10.4.4">
<h3>
<span class="header-section-number">10.4.4</span> Визуализация<a class="anchor" aria-label="anchor" href="#sf_plotting"><i class="fas fa-link"></i></a>
</h3>
<div id="sf_plotting_basic" class="section level4" number="10.4.4.1">
<h4>
<span class="header-section-number">10.4.4.1</span> Базовые возможности<a class="anchor" aria-label="anchor" href="#sf_plotting_basic"><i class="fas fa-link"></i></a>
</h4>
<p>Если попытаться применить функцию <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> к геометрии объекта, она попытается нарисовать тематические карты по всем имеющимся атрибутам (но остановится, если их более 9):</p>
<div class="sourceCode" id="cb446"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-18-1.png" width="100%"></div>
<p>Если задача стоит нарисовать границы объектов, то нужно отображать объект <strong>sfc</strong>:</p>
<div class="sourceCode" id="cb447"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-19-1.png" width="100%"></div>
<p>Для быстрого построения тематических карт по выбранному показателю необходимо при вызове функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> указать соответствующий атрибут фрейма данных:</p>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">countries</span><span class="op">[</span><span class="st">'sovereignt'</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co"># Здесь легенда не нужна</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-20-1.png" width="100%"></div>
<p>Для отображения координатной сетки надо указать параметр <code>graticule = TRUE</code>, а подписей координат — <code>axes = TRUE</code>:</p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">countries</span><span class="op">[</span><span class="st">'gdp_md_est'</span><span class="op">]</span>, graticule <span class="op">=</span> <span class="cn">TRUE</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-21-1.png" width="100%"></div>
</div>
<div id="sf_plotting_basic" class="section level4" number="10.4.4.2">
<h4>
<span class="header-section-number">10.4.4.2</span> Совмещение слоев<a class="anchor" aria-label="anchor" href="#sf_plotting_basic"><i class="fas fa-link"></i></a>
</h4>
<p>Для совмещения нескольких слоев на одной карте необходимо при втором и последующих вызовах функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> указать параметр <code>add = TRUE</code>:</p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oceans</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/ne/oceans.gpkg'</span><span class="op">)</span>
<span class="co">## Reading layer `ocean' from data source `/Users/tsamsonov/GitHub/r-geo-course/data/ne/oceans.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 2 features and 4 fields</span>
<span class="co">## geometry type:  POLYGON</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -180 ymin: -85.60904 xmax: 180 ymax: 90</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="va">rivers</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/ne/rivers.gpkg'</span><span class="op">)</span>
<span class="co">## Reading layer `rivers_lake_centerlines' from data source `/Users/tsamsonov/GitHub/r-geo-course/data/ne/rivers.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 13 features and 8 fields</span>
<span class="co">## geometry type:  LINESTRING</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -135.3134 ymin: -33.99358 xmax: 129.956 ymax: 72.90651</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="va">lakes</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/ne/lakes.gpkg'</span><span class="op">)</span>
<span class="co">## Reading layer `lakes' from data source `/Users/tsamsonov/GitHub/r-geo-course/data/ne/lakes.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 25 features and 8 fields</span>
<span class="co">## geometry type:  POLYGON</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -124.9536 ymin: -16.53641 xmax: 109.9298 ymax: 66.9693</span>
<span class="co">## geographic CRS: WGS 84</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">countries</span> <span class="op">%&gt;%</span> <span class="va">st_geometry</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, border <span class="op">=</span> <span class="st">'gray'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">oceans</span> <span class="op">%&gt;%</span> <span class="va">st_geometry</span>, col <span class="op">=</span> <span class="st">'steelblue1'</span>, border <span class="op">=</span> <span class="st">'steelblue'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">lakes</span> <span class="op">%&gt;%</span> <span class="va">st_geometry</span>, col <span class="op">=</span> <span class="st">'steelblue1'</span>, border <span class="op">=</span> <span class="st">'steelblue'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">rivers</span> <span class="op">%&gt;%</span> <span class="va">st_geometry</span>, col <span class="op">=</span> <span class="st">'steelblue'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-22-1.png" width="100%"></div>
<blockquote>
<p><strong>Внимание</strong>: чтобы слои совместились на карте, они должна иметь одинаковую систему координат.</p>
</blockquote>
<p>Ясно, что на полученных нами картах можно много что улучшить, однако это мы отложим до следующей главы, где подробно разбирается построение тематических карт в <strong>R</strong>.</p>
</div>
</div>
<div id="sf_crs" class="section level3" number="10.4.5">
<h3>
<span class="header-section-number">10.4.5</span> Системы координат и проекции<a class="anchor" aria-label="anchor" href="#sf_crs"><i class="fas fa-link"></i></a>
</h3>
<p>Работа с пространственной привязкой данных в R состоит в основном из четырех операций:</p>
<ul>
<li>чтение информации о системе координат</li>
<li>создание информации о системе координат</li>
<li>замена информации о системе координат</li>
<li>изменение системы координат (проецирование)</li>
</ul>
<p>Первые три операции (чтение, создание, замена) осуществляются функцией <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code>. Чтобы прочитать информацию о проекции, достаточно передать в качестве параметра объект типа <code>sf</code>:</p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>    <span class="co"># Координатная система</span>
<span class="co">## Coordinate Reference System:</span>
<span class="co">##   User input: WGS 84 </span>
<span class="co">##   wkt:</span>
<span class="co">## GEOGCRS["WGS 84",</span>
<span class="co">##     DATUM["World Geodetic System 1984",</span>
<span class="co">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">##             LENGTHUNIT["metre",1]]],</span>
<span class="co">##     PRIMEM["Greenwich",0,</span>
<span class="co">##         ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##     CS[ellipsoidal,2],</span>
<span class="co">##         AXIS["geodetic latitude (Lat)",north,</span>
<span class="co">##             ORDER[1],</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##         AXIS["geodetic longitude (Lon)",east,</span>
<span class="co">##             ORDER[2],</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##     USAGE[</span>
<span class="co">##         SCOPE["unknown"],</span>
<span class="co">##         AREA["World"],</span>
<span class="co">##         BBOX[-90,-180,90,180]],</span>
<span class="co">##     ID["EPSG",4326]]</span></code></pre></div>
<p>Эта же функция позволяет создать новую координатную систему, путем передачи ей кода <em>EPSG</em> или строки <em>PROJ.4</em>:</p>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span> <span class="co"># Проекция Меркатора для карт мира</span>
<span class="co">## Coordinate Reference System:</span>
<span class="co">##   User input: EPSG:3857 </span>
<span class="co">##   wkt:</span>
<span class="co">## PROJCRS["WGS 84 / Pseudo-Mercator",</span>
<span class="co">##     BASEGEOGCRS["WGS 84",</span>
<span class="co">##         DATUM["World Geodetic System 1984",</span>
<span class="co">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">##                 LENGTHUNIT["metre",1]]],</span>
<span class="co">##         PRIMEM["Greenwich",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##         ID["EPSG",4326]],</span>
<span class="co">##     CONVERSION["Popular Visualisation Pseudo-Mercator",</span>
<span class="co">##         METHOD["Popular Visualisation Pseudo Mercator",</span>
<span class="co">##             ID["EPSG",1024]],</span>
<span class="co">##         PARAMETER["Latitude of natural origin",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8801]],</span>
<span class="co">##         PARAMETER["Longitude of natural origin",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8802]],</span>
<span class="co">##         PARAMETER["False easting",0,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8806]],</span>
<span class="co">##         PARAMETER["False northing",0,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8807]]],</span>
<span class="co">##     CS[Cartesian,2],</span>
<span class="co">##         AXIS["easting (X)",east,</span>
<span class="co">##             ORDER[1],</span>
<span class="co">##             LENGTHUNIT["metre",1]],</span>
<span class="co">##         AXIS["northing (Y)",north,</span>
<span class="co">##             ORDER[2],</span>
<span class="co">##             LENGTHUNIT["metre",1]],</span>
<span class="co">##     USAGE[</span>
<span class="co">##         SCOPE["unknown"],</span>
<span class="co">##         AREA["World - 85°S to 85°N"],</span>
<span class="co">##         BBOX[-85.06,-180,85.06,180]],</span>
<span class="co">##     ID["EPSG",3857]]</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">'+proj=robin'</span><span class="op">)</span> <span class="co"># Проекция Робинсона для карт мира</span>
<span class="co">## Coordinate Reference System:</span>
<span class="co">##   User input: +proj=robin </span>
<span class="co">##   wkt:</span>
<span class="co">## PROJCRS["unknown",</span>
<span class="co">##     BASEGEOGCRS["unknown",</span>
<span class="co">##         DATUM["World Geodetic System 1984",</span>
<span class="co">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">##                 LENGTHUNIT["metre",1]],</span>
<span class="co">##             ID["EPSG",6326]],</span>
<span class="co">##         PRIMEM["Greenwich",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8901]]],</span>
<span class="co">##     CONVERSION["unknown",</span>
<span class="co">##         METHOD["Robinson"],</span>
<span class="co">##         PARAMETER["Longitude of natural origin",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8802]],</span>
<span class="co">##         PARAMETER["False easting",0,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8806]],</span>
<span class="co">##         PARAMETER["False northing",0,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8807]]],</span>
<span class="co">##     CS[Cartesian,2],</span>
<span class="co">##         AXIS["(E)",east,</span>
<span class="co">##             ORDER[1],</span>
<span class="co">##             LENGTHUNIT["metre",1,</span>
<span class="co">##                 ID["EPSG",9001]]],</span>
<span class="co">##         AXIS["(N)",north,</span>
<span class="co">##             ORDER[2],</span>
<span class="co">##             LENGTHUNIT["metre",1,</span>
<span class="co">##                 ID["EPSG",9001]]]]</span>

<span class="co"># Проекция UTM, зона 37.</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">'+proj=utm +zone=37 +datum=WGS84 +units=m'</span><span class="op">)</span>
<span class="co">## Coordinate Reference System:</span>
<span class="co">##   User input: +proj=utm +zone=37 +datum=WGS84 +units=m </span>
<span class="co">##   wkt:</span>
<span class="co">## PROJCRS["unknown",</span>
<span class="co">##     BASEGEOGCRS["unknown",</span>
<span class="co">##         DATUM["World Geodetic System 1984",</span>
<span class="co">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">##                 LENGTHUNIT["metre",1]],</span>
<span class="co">##             ID["EPSG",6326]],</span>
<span class="co">##         PRIMEM["Greenwich",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8901]]],</span>
<span class="co">##     CONVERSION["UTM zone 37N",</span>
<span class="co">##         METHOD["Transverse Mercator",</span>
<span class="co">##             ID["EPSG",9807]],</span>
<span class="co">##         PARAMETER["Latitude of natural origin",0,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8801]],</span>
<span class="co">##         PARAMETER["Longitude of natural origin",39,</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">##             ID["EPSG",8802]],</span>
<span class="co">##         PARAMETER["Scale factor at natural origin",0.9996,</span>
<span class="co">##             SCALEUNIT["unity",1],</span>
<span class="co">##             ID["EPSG",8805]],</span>
<span class="co">##         PARAMETER["False easting",500000,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8806]],</span>
<span class="co">##         PARAMETER["False northing",0,</span>
<span class="co">##             LENGTHUNIT["metre",1],</span>
<span class="co">##             ID["EPSG",8807]],</span>
<span class="co">##         ID["EPSG",16037]],</span>
<span class="co">##     CS[Cartesian,2],</span>
<span class="co">##         AXIS["(E)",east,</span>
<span class="co">##             ORDER[1],</span>
<span class="co">##             LENGTHUNIT["metre",1,</span>
<span class="co">##                 ID["EPSG",9001]]],</span>
<span class="co">##         AXIS["(N)",north,</span>
<span class="co">##             ORDER[2],</span>
<span class="co">##             LENGTHUNIT["metre",1,</span>
<span class="co">##                 ID["EPSG",9001]]]]</span></code></pre></div>
<p>Замена координатной системы требуется в тех случаях, когда слой не имеет пространственной привязки, или же она задана некорректно. В этом случае необходимо вызвать для слоя функцию <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code> и перезаписать результат.</p>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span> 
<span class="co">## Coordinate Reference System: NA</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>
<span class="co">## Coordinate Reference System:</span>
<span class="co">##   User input: EPSG:4326 </span>
<span class="co">##   wkt:</span>
<span class="co">## GEOGCRS["WGS 84",</span>
<span class="co">##     DATUM["World Geodetic System 1984",</span>
<span class="co">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">##             LENGTHUNIT["metre",1]]],</span>
<span class="co">##     PRIMEM["Greenwich",0,</span>
<span class="co">##         ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##     CS[ellipsoidal,2],</span>
<span class="co">##         AXIS["geodetic latitude (Lat)",north,</span>
<span class="co">##             ORDER[1],</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##         AXIS["geodetic longitude (Lon)",east,</span>
<span class="co">##             ORDER[2],</span>
<span class="co">##             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">##     USAGE[</span>
<span class="co">##         SCOPE["unknown"],</span>
<span class="co">##         AREA["World"],</span>
<span class="co">##         BBOX[-90,-180,90,180]],</span>
<span class="co">##     ID["EPSG",4326]]</span></code></pre></div>
<blockquote>
<p><strong>Внимание</strong>: замена координатной системы не осуществляет перепроецирования данных и не меняет координаты точек. Она лишь влияет на то, как эти координаты будут интерпретироваться. Если вместо проецирования выполнить замену информации о координатной системе, данные будут позиционироваться в неправильном месте.</p>
</blockquote>
<p>Для трансформирования данных в другую проекцию следует использовать функцию <code>st_tranform(x, crs)</code>. Данная функция принимает в качестве параметров класс объектов <em>sf</em> и координатную систему, в которую необходимо проецировать данные.</p>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Проекция Меркатора</span>
<span class="va">countries.merc</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">countries</span>, <span class="fl">3857</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries.merc</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'lightgray'</span>,
     lwd <span class="op">=</span> <span class="fl">0.5</span>,
     graticule <span class="op">=</span> <span class="cn">TRUE</span>, 
     axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-26-1.png" width="100%"></div>
<div class="sourceCode" id="cb455"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Проекция Робинсона (используем dplyr)</span>
<span class="va">countries.rob</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'+proj=robin'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries.rob</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'lightgray'</span>,
     lwd <span class="op">=</span> <span class="fl">0.5</span>,
     graticule <span class="op">=</span> <span class="cn">TRUE</span>, 
     axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-27-1.png" width="100%"></div>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Зарубежная Европа в Конической равнопромежуточной проекции. </span>
<span class="co"># Задаем только необходимые параметры проекции</span>
<span class="va">europe.conic</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">==</span> <span class="st">'Europe'</span> <span class="op">&amp;</span> <span class="va">sovereignt</span> <span class="op">!=</span> <span class="st">'Russia'</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'+proj=eqdc +lon_0=10 +lat_1=30 +lat_2=60 +datum=WGS84 +units=m'</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">europe.conic</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'lightgray'</span>,
     lwd <span class="op">=</span> <span class="fl">0.5</span>,
     graticule <span class="op">=</span> <span class="cn">TRUE</span>, 
     axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-28-1.png" width="100%"></div>
<blockquote>
<p><strong>Внимание</strong>: чтобы слои данных можно было совместно анализировать и наносить на одну карту, они должны иметь одну и ту же координатную систему (проекцию).</p>
</blockquote>
</div>
<div id="sf_attrs" class="section level3" number="10.4.6">
<h3>
<span class="header-section-number">10.4.6</span> Атрибутивные операции<a class="anchor" aria-label="anchor" href="#sf_attrs"><i class="fas fa-link"></i></a>
</h3>
<p>Поскольку пространственные объекты хранятся в фреймах данных, к ним можно применять стандартные операции выборки по атрибутам и преобразования таблиц. Например, можно выбрать Италию и отобразить ее на отдельной карте:</p>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">italy</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sovereignt</span> <span class="op">==</span> <span class="st">'Italy'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-29-1.png" width="100%"></div>
<p>Следующий пример иллюстрирует как выбрать страны с населением более 100 млн человек:</p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">largest</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pop_est</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pop_est</span> <span class="op">&gt;</span> <span class="fl">100000000</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, col <span class="op">=</span> <span class="st">'lightgrey'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">largest</span>, col <span class="op">=</span> <span class="st">'red'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-30-1.png" width="100%"></div>
<p>Обратите внимание на то, что при вызове функции <code><a href="https://rdrr.io/pkg/raster/man/select.html">select()</a></code> столбец <code>geometry</code> не был указан в числе выбираемых переменных. Тем не менее, то, что мы смогли построить карту по результатам выборки, говорит о том, что данный столбец был сохранен. <em>Функции <strong>dplyr</strong> определены для объектов <code>sf</code> таким образом, чтобы всегда сохранять геометрический столбец.</em></p>
<p>Еще интереснее работает агрегирование объектов по атрибутам. В случае, когда агрегируются пространственные объекты, необходимо объединять и их геометрию. При этом если у агрегируемых объектов имеется общая граница, ее необходимо удалить, а если объекты разнесены в пространстве, из них нужно собрать новый мульти-объект.</p>
<p>Например, мы можем агрегировать валовой региональный продукт по континентам:</p>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">continents</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">continent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>gdp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">gdp_md_est</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">continents</span><span class="op">[</span><span class="st">'gdp'</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-31-1.png" width="100%"></div>
<p>Потрясающе просто, не правда ли? Вдобавок, мы еще и получили границы континентов (достаточно условные, конечно), которых у нас раньше не было. Данный пример также показывает, что атрибутивные операции над пространственными объектами всегда учитывают их геометрию.</p>
</div>
<div id="sf_spat_selection" class="section level3" number="10.4.7">
<h3>
<span class="header-section-number">10.4.7</span> Пространственные операции<a class="anchor" aria-label="anchor" href="#sf_spat_selection"><i class="fas fa-link"></i></a>
</h3>
<p>Поиск объектов по местоположению базируется на проверке топологических отношений между объектами. Топологические отношения описывают взаимное расположение объектов. Различные варианты топологических отношений для площадных объектов представлены на следующем рисунке, где серым цветом показаны пересечения <em>внутренних областей</em> объектов <span class="math inline">\(A\)</span> и <span class="math inline">\(B\)</span>, синим цветом — пересечения <em>границ</em> объектов <span class="math inline">\(A\)</span> и <span class="math inline">\(B\)</span>:
<img src="10-SpatialData_files/figure-html/unnamed-chunk-32-1.png" width="100%"></p>
<p>Отношение <em>Пересекает (intersects)</em> будет истинно для любого случая когда две геометрии имеют хотя бы одну общую точку, то есть во всех случаях кроме <em>Не пересекает (disjoint)</em>. Для проверки этих, а также некоторых других отношений, в пакете <code>sf</code> существует ряд функций:</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="30%">
<col width="69%">
</colgroup>
<thead><tr class="header">
<th>Функция</th>
<th>Топологическое отношение</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects(x, y)</a></code></td>
<td>
<code>x</code> имеет общие точки с <code>y</code>
</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_disjoint(x, y)</a></code></td>
<td>
<code>x</code> не имеет общих точек с <code>y</code>
</td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_touches(x, y)</a></code></td>
<td>
<code>x</code> касается <code>y</code> (граница <code>x</code> имеет общие точки с границей <code>y</code> И внутренняя область <code>x</code> не имеет имеет общих точек с внутренней областью <code>y</code>)</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_crosses(x, y)</a></code></td>
<td>
<code>x</code> пересекает <code>y</code> (граница <code>x</code> имеет общие точки с границей <code>y</code>, при этом размерность их пересечения меньше размерности хотя бы одного из исходных объектов)</td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_within(x, y)</a></code></td>
<td>
<code>x</code> внутри <code>y</code> (все точки <code>x</code> содержатся в <code>y</code> И внутренняя область <code>x</code> имеет общие точки с внутренней областью <code>y</code>)</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_contains(x, y)</a></code></td>
<td>
<code>x</code> содержит <code>y</code> (все точки <code>y</code> содержатся в <code>x</code> И внутренняя область <code>y</code> имеет общие точки с внутренней областью <code>x</code>)</td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_contains_properly(x, y)</a></code></td>
<td>
<code>x</code> содержит <code>y</code> полностью (все точки <code>y</code> содержатся в <code>x</code> И граница <code>x</code> не имеет общих точек с границей <code>y</code>)</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_overlaps(x, y)</a></code></td>
<td>
<code>x</code> перекрывает <code>y</code> (внутренняя область <code>x</code> имеет как общие, так и не общие точки с внутренней областью <code>y</code>)</td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_equals(x, y)</a></code></td>
<td>
<code>x</code> совпадает <code>y</code> (множества точек <code>x</code> и <code>y</code> совпадают)</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_covers(x, y)</a></code></td>
<td>
<code>x</code> покрывает <code>y</code> (все точки <code>y</code> содержатся в <code>x</code>)</td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_covered_by(x, y)</a></code></td>
<td>
<code>x</code> покрыт <code>y</code> (все точки <code>x</code> содержатся в <code>y</code>)</td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_equals_exact(x, y)</a></code></td>
<td>
<code>x</code> совпадает <code>y</code> точно (упорядоченные множества точек <code>x</code> и <code>y</code> совпадают)</td>
</tr>
</tbody>
</table></div>
<p>Между <code>covered_by</code> и <code>within</code>, а также <code>covers</code> и <code>contains</code> нет разницы в случае, когда оба объекта являются площадными. Эта разница будет сказываться если хотя бы один из объектов является линией либо точкой. В этом случае <code>within</code>, <code>contains</code> и <code>contains_properly</code> будут давать ложный результат (FALSE), поскольку ни у линий, ни у точек нет внутренней области.</p>
<p>Проверка топологических отношений используется для выполнения выборки объектов по местоположению — <em>пространственной выборки</em>. Наиболее простой способ выбрать объекты по пространственному местоположению — это использовать один слой в качестве фильтра для другого слоя. В этом случае будет по умолчанию использовано отношение <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects()</a></code> (пересекает). Никаких отличий от работы с обычными таблицами нет. Например, вот так можно выбрать точки, находящиеся внутри ранее отобранных стран с максимальным ВВП:</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cities</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/ne/cities.gpkg'</span><span class="op">)</span>
<span class="co">## Reading layer `populated_places' from data source `/Users/tsamsonov/GitHub/r-geo-course/data/ne/cities.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 243 features and 103 fields</span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: -175.2206 ymin: -41.29999 xmax: 179.2166 ymax: 64.15002</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="va">city.pts</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">cities</span><span class="op">)</span>

<span class="co"># Наносим исходную конфигурацию</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cities</span>, col <span class="op">=</span> <span class="st">'black'</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-33-1.png" width="100%"></div>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Отбираем точки внутри стран с максимальным ВВП</span>
<span class="va">sel</span> <span class="op">=</span> <span class="va">cities</span><span class="op">[</span><span class="va">largest</span>, <span class="op">]</span>

<span class="co"># Смотрим что получилось</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">largest</span>, col <span class="op">=</span> <span class="st">'gray'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">sel</span>, pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">'black'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-33-2.png" width="100%"></div>
<p>Разумеется, при выполнении пространственных запросов могут возникать и другие пространственные отношения. Например, мы можем выбрать все страны, имеющие общую границу с Чехией. Для этого можно использовать топологическое отношение <code>st_touches</code> вместо <code>st_intersects</code> — это будет гарантировать, что сама Чехия в результате не выберется (касающиеся объекты не могут перекрываться). Тип отношения необходимо поставить в параметр <code>op =</code> при выполнении фильтрации фрейма данных:</p>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cz</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sovereignt</span> <span class="op">==</span> <span class="st">'Czechia'</span><span class="op">)</span>
<span class="va">neighbors</span> <span class="op">=</span> <span class="va">countries</span><span class="op">[</span><span class="va">cz</span>, op <span class="op">=</span> <span class="va">st_touches</span><span class="op">]</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">neighbors</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'lightgray'</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cz</span>, col <span class="op">=</span> <span class="st">'darkgray'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-34-1.png" width="100%"></div>
</div>
<div id="sf_creation" class="section level3" number="10.4.8">
<h3>
<span class="header-section-number">10.4.8</span> Создание пространственных объектов<a class="anchor" aria-label="anchor" href="#sf_creation"><i class="fas fa-link"></i></a>
</h3>
<p>Пространственные объекты в R можно собирать “вручную,” если есть такая необходимость. Например, вам известны координаты границ участков полевого обследования, полученные посредством GPS, а вам необходимо превратить их в полигоны, чтобы выполнить анализ и картографирование. Придется из координат собрать полигоны программным путем. Процесс создания пространственных объектов осуществляется в последовательности их иерархического соподчинения: <strong>sfg</strong> &gt; <strong>sfc</strong> &gt; <strong>sf</strong>.</p>
<div id="sf_sfg" class="section level4" number="10.4.8.1">
<h4>
<span class="header-section-number">10.4.8.1</span> Геометрические объекты (sfg)<a class="anchor" aria-label="anchor" href="#sf_sfg"><i class="fas fa-link"></i></a>
</h4>
<p>Для создания геометрических объектов в пакете sf существует ряд функций с говорящими названиями:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>Функция</th>
<th>Тип пространственного объекта</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_point()</a></code></td>
<td><em>POINT</em></td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring()</a></code></td>
<td><em>LINESTRING</em></td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon()</a></code></td>
<td><em>POLYGON</em></td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipoint()</a></code></td>
<td><em>MULTIPOINT</em></td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_multilinestring()</a></code></td>
<td><em>MULTILINESTRING</em></td>
</tr>
<tr class="even">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipolygon()</a></code></td>
<td><em>MULTIPOLYGON</em></td>
</tr>
<tr class="odd">
<td><code><a href="https://r-spatial.github.io/sf/reference/st.html">st_geometrycollection()</a></code></td>
<td><em>GEOMETRYCOLLECTION</em></td>
</tr>
</tbody>
</table></div>
<p>В зависимости от типа создаваемого объекта, данные функции принимают координаты, организованные в виде одной из трех структур данных:</p>
<ul>
<li>Вектор координат (<em>POINT</em>)</li>
<li>Матрица координат (<em>MULTIPOINT</em> или <em>LINESTRING</em>), в которой строки соответствуют точкам, столбцы — координатам</li>
<li>Список (для всех остальных типов)</li>
</ul>
<p>Проще всего создаются отдельные <strong>точки</strong> (<em>POINT</em>):</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># XY POINT</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co"># XYZ POINT</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>, dim <span class="op">=</span> <span class="st">'XYM'</span><span class="op">)</span> <span class="co"># XYM POINT</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co"># XYZM POINT</span></code></pre></div>
<p>Дополнительный параметр <code>dim=</code> служит для уточнения типа геометрии точек и по сути нужен только тогда, когда необходимо создать редко используемые точки типа <em>XYM</em>. во всех остальных случаях (<em>XY</em>, <em>XYZ</em>, <em>XYZM</em>) размерность геометрии распознается по умолчанию.</p>
<p>При создании <strong>мультиточек</strong> (<em>MULTIPOINT</em>) и <strong>линий</strong> (<em>LINESTRING</em>) необходимо подавать на вход функции уже матрицу координат:</p>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coords</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">0</span>, <span class="fl">2</span>,
  <span class="fl">1</span>, <span class="fl">3</span>,
  <span class="fl">3</span>, <span class="fl">1</span>,
  <span class="fl">5</span>, <span class="fl">0</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">mp</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipoint</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="co"># XY MULTIPOINT</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mp</span><span class="op">)</span>

<span class="va">ls</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="co"># XY LINESTRING</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ls</span><span class="op">)</span></code></pre></div>
<p>В первом случае геометрия состоит из отдельных точек. Во втором случае те же самые точки соединены линией:</p>
<div class="sourceCode" id="cb465"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ls</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mp</span>, col <span class="op">=</span> <span class="st">'red'</span>, pch <span class="op">=</span> <span class="fl">19</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-37-1.png" width="100%"></div>
<p>Создание трех-(<em>XYZ</em>, <em>XYM</em>) и четырехмерных (<em>ZYXM</em>) мультиточек и линий выполняется аналогично, но матрица должна содержать не 2, а, соответственно 3 или 4 столбца, и при необходимости параметр <code>dim = 'XYM'</code>.</p>
<p>Создание <strong>полигонов</strong> (<em>POLYGON</em>), <strong>мультиполигонов</strong> (<em>MULTIPOLYGON</em>) и <strong>мультилиний</strong> (<em>MULTILINESTRING</em>) требует уже создания списков из матриц.</p>
<p>Почему нельзя представить обычный (не мульти) полигон просто матрицей координат? Потому что полигон может содержать дырки. Например, контур леса может содержать дырку в том месте, где находится озеро. Или озеро может содержать дырку в том месте, где находится остров. Природа предлагает нам бесконечное число таких примеров. В целях универсализации приходится закладываться на возможность наличия дырок в полигонах, поэтому даже полигоны без дырок представляются в виде списков. При этом действу.т следующее правила:</p>
<ul>
<li>Первая матрица координат в списке отвечает за контур полигона</li>
<li>Все остальные матрицы координат отвечают за дыры в полигоне</li>
<li>Координаты первой и последней точки в каждой матрице должны совпадать</li>
</ul>
<p>Если дыр в полигоне нет, его список будет содержать только одну матрицу. Рассмотрим оба примера построения <strong>полигонов</strong>:</p>
<div class="sourceCode" id="cb466"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coords</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># Координаты главного полигона</span>
  <span class="fl">1</span>, <span class="fl">0</span>,
  <span class="fl">0</span>, <span class="fl">2</span>,
  <span class="fl">2</span>, <span class="fl">3</span>,
  <span class="fl">4</span>, <span class="fl">2</span>,
  <span class="fl">3</span>, <span class="fl">0.5</span>,
  <span class="fl">1</span>, <span class="fl">0</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">pol</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span><span class="op">)</span> <span class="co"># Простой полигон</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pol</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pol</span>, col <span class="op">=</span> <span class="st">'lightblue'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-38-1.png" width="100%"></div>
<div class="sourceCode" id="cb467"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">hole</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># Координаты дыры</span>
  <span class="fl">2</span>, <span class="fl">1</span>,
  <span class="fl">3</span>, <span class="fl">1.5</span>,
  <span class="fl">3</span>, <span class="fl">2</span>,
  <span class="fl">2</span>, <span class="fl">2</span>,
  <span class="fl">1.5</span>, <span class="fl">1.5</span>,
  <span class="fl">2</span>, <span class="fl">1</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">pol2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">hole</span><span class="op">)</span><span class="op">)</span> <span class="co"># Полигон с дырой</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pol2</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pol2</span>, col <span class="op">=</span> <span class="st">'lightblue'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-38-2.png" width="100%"></div>
<p>Мультиполигоны (<em>MULTIPOLYGON</em>) и мультилинии (<em>MULTILINESTRING</em>) требуются тогда, когда один и тот же географический объект состоит из нескольких геометрических объектов. Простейший пример — островные государства. Чтобы представить страну, занимающую архипелаг (Багамские острова, Индонезия, Япония и т.д.) как один пространственный объект, необходимо создать мультиполигон. Все компоненты мультиполигона будут иметь общий набор атрибутов (непространственных характеристик). Мультилинии используются реже мультиполигонов и необходимы для представления линейных объектов, разорванных в пространстве. Примером такого объекта может быть любая река или канал, которые разорваны в тех местах, где они протекают через озеро или водохранилище, представленное полигональным объектом.</p>
<p>В мультиполигонах добавляется еще один уровень списка, то есть искомые матрицы координат будут располагаться как минимум на втором уровне вложенности:</p>
<div class="sourceCode" id="cb468"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coords1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">0.5</span>, <span class="fl">0</span>,
  <span class="fl">0</span>, <span class="fl">1</span>,
  <span class="fl">1</span>, <span class="fl">1.5</span>,
  <span class="fl">2</span>, <span class="fl">1</span>,
  <span class="fl">1.5</span>, <span class="fl">0.25</span>,
  <span class="fl">0.5</span>, <span class="fl">0</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">coords2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">3</span>, <span class="fl">1</span>,
  <span class="fl">2.5</span>, <span class="fl">2</span>,
  <span class="fl">3.5</span>, <span class="fl">2.5</span>,
  <span class="fl">4</span>, <span class="fl">2</span>,
  <span class="fl">4</span>, <span class="fl">1.25</span>,
  <span class="fl">3</span>, <span class="fl">1</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">mpol</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipolygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mpol</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pol</span>, col <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span> <span class="co"># Обычный полигон (серый)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mpol</span>, col <span class="op">=</span> <span class="st">'pink'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Мультиполигон (розовый)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-39-1.png" width="100%"></div>
<p>Как насчет острова на озере? Если остров и суша, окружающая озеро, составляют единое целое (например, подлежат учету как единый массив леса), их можно собрать как мультиполигон. В этом случае первая компонента мультиполигона будет представлять собой полигон с дыркой, а вторая компонента — остров. Порядок компонент в данном случае роли не играет:</p>
<div class="sourceCode" id="cb469"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coords4</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">2.2</span>, <span class="fl">1.2</span>,
  <span class="fl">2.8</span>, <span class="fl">1.5</span>,
  <span class="fl">2.8</span>, <span class="fl">1.8</span>,
  <span class="fl">2.2</span>, <span class="fl">1.8</span>,
  <span class="fl">2.0</span>, <span class="fl">1.6</span>,
  <span class="fl">2.2</span>, <span class="fl">1.2</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">island</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords4</span><span class="op">)</span><span class="op">)</span>

<span class="va">mpol2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipolygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">pol2</span>, <span class="va">island</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mpol2</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mpol2</span>, col <span class="op">=</span> <span class="st">'darkolivegreen4'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-40-1.png" width="100%"></div>
<p>Из данного примера также видно, что при сборе мультиполигона на самом нижнем уровне вложенности можно подавать не списки матриц координат, а готовые полигоны.</p>
<p>Мультилиния, в отличие от мультиполигона, не требует дополнительного списка верхнего уровня, поскольку линии не могут содержать дыр. Например, можно собрать мультилинию из двух частей, соответствующих участкам реки до и после озера:</p>
<div class="sourceCode" id="cb470"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coords1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="op">-</span><span class="fl">3</span>, <span class="fl">0</span>,
  <span class="op">-</span><span class="fl">1</span>, <span class="fl">2</span>,
  <span class="fl">0</span>, <span class="fl">2</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">coords2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">4</span>, <span class="fl">2</span>,
  <span class="fl">5</span>, <span class="fl">3</span>,
  <span class="fl">6</span>, <span class="fl">5</span>
<span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">mline</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multilinestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coords1</span>, <span class="va">coords2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mline</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mline</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pol2</span>, col <span class="op">=</span> <span class="st">'lightblue'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-41-1.png" width="100%"></div>
<p>Наконец, еще один вид геометрии — это геометрическая коллекция (GEOMETRYCOLLECTION), который позволяет хранить вместе любые виды геометрий. Эта возможность используется достаточно редко, тем не менее, рассмотреть ее нужно. Геометрическая коллекция собирается из списка объектов с простыми типами геометрии (мы создали их ранее):</p>
<div class="sourceCode" id="cb471"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_geometrycollection</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">ls</span>, <span class="va">mp</span>, <span class="va">mline</span>, <span class="va">pol2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-42-1.png" width="100%"></div>
</div>
<div id="sf_sfc" class="section level4" number="10.4.8.2">
<h4>
<span class="header-section-number">10.4.8.2</span> Списки геометрических объектов (sfc)<a class="anchor" aria-label="anchor" href="#sf_sfc"><i class="fas fa-link"></i></a>
</h4>
<p>Списки геометрических объектов (класс <code>sfc</code>) используются в таблицах пространственных объектов в качестве столбца, который хранит геометрию объектов. Создание таких списков осуществляется функцией <code><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc()</a></code>, которой достаточно передать в качестве перечня параметров объекты типа <code>sfg</code>. Рассмотрим создание списка геометрий на примере точечных объектов (для остальных типов объектов порядок действий не меняется):</p>
<div class="sourceCode" id="cb472"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">moscow.sfg</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">37.615</span>, <span class="fl">55.752</span><span class="op">)</span><span class="op">)</span>
<span class="va">irkutsk.sfg</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">104.296</span>, <span class="fl">52.298</span><span class="op">)</span><span class="op">)</span>
<span class="va">petro.sfg</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">158.651</span>, <span class="fl">53.044</span><span class="op">)</span><span class="op">)</span>

<span class="va">cities.sfc</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">moscow.sfg</span>, <span class="va">irkutsk.sfg</span>, <span class="va">petro.sfg</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cities.sfc</span><span class="op">)</span>
<span class="co">## Geometry set for 3 features </span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span>
<span class="co">## CRS:            NA</span></code></pre></div>
<p>При создании списка геометрий для него может быть определена система координат (это можно сделать и позднее при создании таблицы пространственных объектов). Для этого используем уже знакомую нам функцию <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code>:</p>
<div class="sourceCode" id="cb473"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">cities.sfc</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="co"># WGS84</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cities.sfc</span><span class="op">)</span>
<span class="co">## Geometry set for 3 features </span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span>
<span class="co">## geographic CRS: WGS 84</span></code></pre></div>
<blockquote>
<p>Для списка геометрий может быть определена только одна система координат</p>
</blockquote>
<p>Можно посмотреть, куда легли наши точки:</p>
<div class="sourceCode" id="cb474"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cities.sfc</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span>
<span class="va">countries</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sovereignt</span> <span class="op">==</span> <span class="st">'Russia'</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span>add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-45-1.png" width="100%"></div>
</div>
<div id="sf_sf" class="section level4" number="10.4.8.3">
<h4>
<span class="header-section-number">10.4.8.3</span> Пространственные объекты (sf)<a class="anchor" aria-label="anchor" href="#sf_sf"><i class="fas fa-link"></i></a>
</h4>
<p>Пространственные объекты (класс <code>sf</code>) организуются в виде фрейма данных, один из столбцов которого имеет класс <code>sfc</code>. Для этого следует сначала создать обычный фрейм данных с атрибутами, а затем соединить его со списком геометрий посредством функции <code>st_sf</code>:</p>
<div class="sourceCode" id="cb475"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">city.attr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Москва'</span>, <span class="st">'Иркутск'</span>, <span class="st">'Петропавловск-Камчатский'</span><span class="op">)</span>,
  established <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1147</span>, <span class="fl">1661</span>, <span class="fl">1740</span><span class="op">)</span>,
  population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12500</span>, <span class="fl">620</span>, <span class="fl">180</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">cites.sf</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span><span class="va">city.attr</span>, geometry <span class="op">=</span> <span class="va">cities.sfc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cites.sf</span><span class="op">)</span>
<span class="co">## Simple feature collection with 3 features and 3 fields</span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="co">##                       name established population               geometry</span>
<span class="co">## 1                   Москва        1147      12500  POINT (37.615 55.752)</span>
<span class="co">## 2                  Иркутск        1661        620 POINT (104.296 52.298)</span>
<span class="co">## 3 Петропавловск-Камчатский        1740        180 POINT (158.651 53.044)</span></code></pre></div>
</div>
<div id="sf_geom_points" class="section level4" number="10.4.8.4">
<h4>
<span class="header-section-number">10.4.8.4</span> Точки по координатам<a class="anchor" aria-label="anchor" href="#sf_geom_points"><i class="fas fa-link"></i></a>
</h4>
<p>Достаточно распространенной является следующая задача: имеются координаты точек в табличной форме, необходимо создать на их основе набор пространственных объектов. Для решения этой задачи можно воспользоваться функцией <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf()</a></code>. Рассмотрим задачу на примере файла координат станций из базы метеорологических данных <a href="http://meteo.ru/"><strong>ВНИИГМИ-МЦД</strong></a>:</p>
<div class="sourceCode" id="cb476"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">stations</span> <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_fwf.html">read_fwf</a></span><span class="op">(</span><span class="st">'data/vniigmi/stations.txt'</span>, 
                    col_positions <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_fwf.html">fwf_widths</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span>, <span class="fl">42</span>, <span class="fl">47</span>, <span class="fl">53</span>, <span class="fl">59</span>, <span class="fl">67</span>, <span class="fl">71</span><span class="op">)</span><span class="op">)</span>, 
                                               col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'id'</span>, <span class="st">'name'</span>, <span class="st">'lat'</span>, <span class="st">'t1'</span>, <span class="st">'lon'</span>, <span class="st">'t2'</span>, <span class="st">'z'</span><span class="op">)</span><span class="op">)</span>,
                    locale <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/locale.html">locale</a></span><span class="op">(</span>encoding <span class="op">=</span> <span class="st">'CP1251'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">## # A tibble: 1,124 x 7</span>
<span class="co">##       id name                  lat t1      lon t2        z</span>
<span class="co">##    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">##  1 20046 Им.Э.Т.Кренкеля,ГМО  80.6 с.ш.   58   в.д.     21</span>
<span class="co">##  2 20069 Остров_Визе          79.5 с.ш.   77.0 в.д.     10</span>
<span class="co">##  3 20087 Голомянный           79.6 с.ш.   90.6 в.д.      7</span>
<span class="co">##  4 20107 Баренцбург           78.1 с.ш.   14.2 в.д.     73</span>
<span class="co">##  5 20289 Русский              77.2 с.ш.   96.4 в.д.      9</span>
<span class="co">##  6 20292 Им.Е.К.Федорова,ГМО  77.7 с.ш.  104.  в.д.     12</span>
<span class="co">##  7 20353 мыс_Желания          77.0 с.ш.   68.6 в.д.      9</span>
<span class="co">##  8 20476 Стерлегова           75.4 с.ш.   88.9 в.д.     10</span>
<span class="co">##  9 20667 Им.М.В.Попова        73.3 с.ш.   70.0 в.д.      4</span>
<span class="co">## 10 20674 Остров_Диксон        73.5 с.ш.   80.4 в.д.     42</span>
<span class="co">## # … with 1,114 more rows</span></code></pre></div>
<p>Теперь создадим пространственные точки на основе этой таблицы, взяв координаты из столбцов <em>lat</em> и <em>lon</em> соответственно и указав код системы координат:</p>
<div class="sourceCode" id="cb477"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sf_stations</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">stations</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">sf_stations</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">'red'</span>, cex <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>, border <span class="op">=</span> <span class="st">'grey'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-48-1.png" width="100%"></div>
</div>
<div id="sf_cast" class="section level4" number="10.4.8.5">
<h4>
<span class="header-section-number">10.4.8.5</span> Преобразование типов геометрии<a class="anchor" aria-label="anchor" href="#sf_cast"><i class="fas fa-link"></i></a>
</h4>
<p>Для преобразования типов геометрии существует функция <code><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast()</a></code>. Функция принимает объекты классов <code>sfg</code>, <code>sfc</code> или <code>sf</code>, а также название типа геометрии, к которому необходимо привести входные объекты. Довольно часто возникает задача конвертации площадного объекта в линейный и обратно, а также задача получения координат вершин линейного или площадного объекта в виде точек. Примеры преобразований:</p>
<div class="sourceCode" id="cb478"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">italy.borders</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">italy</span>, <span class="st">'MULTILINESTRING'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">italy.borders</span><span class="op">)</span><span class="op">)</span>
<span class="co">## [1] "sfc_MULTILINESTRING" "sfc"</span>

<span class="va">italy.regions</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">italy.borders</span>, <span class="st">'MULTIPOLYGON'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">italy.regions</span><span class="op">)</span><span class="op">)</span>
<span class="co">## [1] "sfc_MULTIPOLYGON" "sfc"</span>

<span class="va">italy.points</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">italy.borders</span>, <span class="st">'POINT'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">italy.points</span><span class="op">)</span><span class="op">)</span>
<span class="co">## [1] "sfc_POINT" "sfc"</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">italy.regions</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">italy.points</span>, pch <span class="op">=</span> <span class="fl">20</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-49-1.png" width="100%"></div>
</div>
<div id="sf_polygonize" class="section level4" number="10.4.8.6">
<h4>
<span class="header-section-number">10.4.8.6</span> Полигонизация и разбиение линий<a class="anchor" aria-label="anchor" href="#sf_polygonize"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Полигонизация</strong> — это процесс преобразования линии или мультилинии в полигон(ы). Полигон может быть образован последовательностью из одной и более линий, для которых выполняются следующие условия:</p>
<ol style="list-style-type: decimal">
<li>Каждая линия является простой (не имеет самопересечений)</li>
<li>Линии касаются только своими начальными и конечными точками</li>
<li>Линии образуют замкнутую последовательность (т.е. выйдя из любой конечной точки и двигаясь вдоль множества линий, можно вернуться в ту же точку.)</li>
</ol>
<p>Полигонизация может применяться только к одному геометрическому объекту (simple feature geometry). Соответственно, это должна быть либо просто замкнутая линия, либо мультилиния, компоненты которой образуют замкнутую последовательность.</p>
<p>Рассмотрим операции полигонизации и добавления узлов на простом примере трех пересекающихся отрезков:</p>
<div class="sourceCode" id="cb479"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Создадим три линии</span>
<span class="va">coords1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>
<span class="va">line1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="va">coords1</span><span class="op">)</span>

<span class="va">coords2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">line2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="va">coords2</span><span class="op">)</span>

<span class="va">coords3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">line3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="va">coords3</span><span class="op">)</span>

<span class="co"># Создадим мультилинию</span>
<span class="va">mls</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multilinestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">line1</span>, <span class="va">line2</span>, <span class="va">line3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mls</span><span class="op">)</span>

<span class="co"># Посмотрим на ее точки</span>
<span class="va">points</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">mls</span>, <span class="st">'MULTIPOINT'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">points</span>, pch <span class="op">=</span> <span class="fl">20</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-50-1.png" width="100%"></div>
<p>Из рисунка видно, что линии образуют треугольную замкнутую область. Также рисунок показывает, что у компонент мультилинии нет вершин в точках пересечения. Мы можем попытаться найти замкнутые области и превратить их в полигоны, используя <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_polygonize()</a></code>:</p>
<div class="sourceCode" id="cb480"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_polygonize</a></span><span class="op">(</span><span class="va">mls</span><span class="op">)</span></code></pre></div>
<p>Операция завершилась возвратом пустой геометрической коллекции, то есть программа не смогла выделить замкнутые области. Это произошло по причине того, что линии не разбиты в точках пересечения. Разбить их на компоненты можно, используя функцию <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_node()</a></code>:</p>
<div class="sourceCode" id="cb481"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mls2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_node</a></span><span class="op">(</span><span class="va">mls</span><span class="op">)</span>
<span class="va">poly2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_polygonize</a></span><span class="op">(</span><span class="va">mls2</span><span class="op">)</span>
<span class="va">points2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">mls2</span>, <span class="st">'MULTIPOINT'</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">mls2</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly2</span>, col <span class="op">=</span> <span class="st">'grey'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">points2</span>, pch <span class="op">=</span> <span class="fl">20</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-52-1.png" width="100%"></div>
<p>Таким образом, после разбиения линий на куски в точках пересечения стала возможной операция полигонизации.</p>
</div>
</div>
<div id="sf_geom_attrs" class="section level3" number="10.4.9">
<h3>
<span class="header-section-number">10.4.9</span> Геометрические атрибуты<a class="anchor" aria-label="anchor" href="#sf_geom_attrs"><i class="fas fa-link"></i></a>
</h3>
<p>К описательным характеристикам геометрии относятся ограничивающий прямоугольник, периметр (для линий и полигонов), площадь (для полигонов), центроид и список координат, которые можно получить с помощью функций <code><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_length()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid()</a></code> и <code><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates()</a></code> соответственно. Функции корректно работают для простых объектов, мультиобъектов, списков геометрий и пространственных объектов. Применительно к полигону Италии эти параметры будут учитывать части геометрии, занимаемые островами:</p>
<div class="sourceCode" id="cb482"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span>        <span class="co"># Координаты органичивающего прямоугольника</span>
<span class="co">##      xmin      ymin      xmax      ymax </span>
<span class="co">##  6.749955 36.619987 18.480247 47.115393</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span>        <span class="co"># Площадь</span>
<span class="co">## 315104851198 [m^2]</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_length</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span>      <span class="co"># Периметр</span>
<span class="co">## 5323111 [m]</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Центроид (может быть не внутри для невыпуклых фигур)</span>
<span class="co">## Geometry set for 1 feature </span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: 12.14079 ymin: 42.75118 xmax: 12.14079 ymax: 42.75118</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_point_on_surface</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Точка гарантированно внутри, но не обязательно в центре</span>
<span class="co">## Geometry set for 1 feature </span>
<span class="co">## geometry type:  POINT</span>
<span class="co">## dimension:      XY</span>
<span class="co">## bbox:           xmin: 12.63118 ymin: 42.55822 xmax: 12.63118 ymax: 42.55822</span>
<span class="co">## geographic CRS: WGS 84</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Список координат</span>
<span class="co">##             X        Y L1 L2 L3</span>
<span class="co">## [1,] 10.44270 46.89355  1  1  1</span>
<span class="co">## [2,] 11.04856 46.75136  1  1  1</span>
<span class="co">## [3,] 11.16483 46.94158  1  1  1</span>
<span class="co">## [4,] 12.15309 47.11539  1  1  1</span>
<span class="co">## [5,] 12.37649 46.76756  1  1  1</span>
<span class="co">## [6,] 13.80648 46.50931  1  1  1</span></code></pre></div>
<p>Обратите внимание на то, что площадь и периметр выводятся с указанием единиц измерений! Это возможно благодаря тому, что объекты типа <code>sf</code> поддерживают единицы измерений на основе пакета <a href="https://cran.r-project.org/web/packages/units/index.html">units</a>.</p>
<blockquote>
<p>Если данные находятся в плоской прямоугольной системе координат, то единицы измерения как правило указываются в параметрах проекции — следовательно, они могут быть использованы при вычислении геометрических параметров объектов. Если же данные хранятся в широтах и долготах, то вычисление геометрических параметров осуществляется пакетом <em>sf</em> по формулам сферической тригонометрии через пакет <a href="https://cran.r-project.org/web/packages/geosphere/index.html">geosphere</a>. Это позволяет выводить результат в плоских единицах измерения.</p>
</blockquote>
<p>Ограничивающий прямоугольник можно быстро преобразовать в полигон и нанести на карту, применив функцию <code><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc()</a></code>:</p>
<div class="sourceCode" id="cb483"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">box</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span><span class="op">)</span> <span class="co"># Ограничивающий прямоугольник</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">italy</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'lightgrey'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">box</span>, 
     border <span class="op">=</span> <span class="st">'orangered'</span>, 
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'darkgreen'</span>, 
     pch <span class="op">=</span> <span class="fl">19</span>,
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_point_on_surface</a></span><span class="op">(</span><span class="va">italy</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'steelblue4'</span>, 
     pch <span class="op">=</span> <span class="fl">19</span>,
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-54-1.png" width="100%"></div>
<p>Как видно, в данном случае центроид и характерная точка расположились относительно рядом. Однако так бывает далеко не всегда. Выполним аналогичные вычисления для Индонезии:</p>
<div class="sourceCode" id="cb484"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">indonesia</span> <span class="op">=</span> <span class="va">countries</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sovereignt</span> <span class="op">==</span> <span class="st">'Indonesia'</span><span class="op">)</span>

<span class="va">box</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">indonesia</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">indonesia</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'lightgrey'</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">box</span>, 
     border <span class="op">=</span> <span class="st">'red'</span>, 
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">indonesia</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'darkgreen'</span>, 
     pch <span class="op">=</span> <span class="fl">19</span>,
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_point_on_surface</a></span><span class="op">(</span><span class="va">indonesia</span><span class="op">)</span>, 
     col <span class="op">=</span> <span class="st">'steelblue4'</span>, 
     pch <span class="op">=</span> <span class="fl">19</span>,
     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-55-1.png" width="100%"></div>
<p>Как видно, в данном случае центроид мультиполигона оказался за пределами какой-либо из его полигональных компонент, в то время как характерная точка находится внутри одного из полигонов. Таким образом, если необходимо получить точку, находящуюся гарантированно в пределах исходного множества, следует использовать <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_point_on_surface()</a></code>. При этом следует помнить, что характерная точка, в отличие от центроида, может не располагаться в визуальном центре тяжести множества объектов, и выбор между этими способами описания геометрии остается за разработчиком.</p>
</div>
<div id="sf_export" class="section level3" number="10.4.10">
<h3>
<span class="header-section-number">10.4.10</span> Экспорт<a class="anchor" aria-label="anchor" href="#sf_export"><i class="fas fa-link"></i></a>
</h3>
<p>Для экспорта векторных пространственных данных можно воспользоваться функцией <code><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write()</a></code>, которая определит формат выходного файла по указанному вами расширению:</p>
<div class="sourceCode" id="cb485"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span><span class="va">cites.sf</span>, <span class="st">'data/mycities.shp'</span><span class="op">)</span> <span class="co"># Шейп-файл</span></code></pre></div>
</div>
</div>
<div id="raster_data_r" class="section level2" number="10.5">
<h2>
<span class="header-section-number">10.5</span> Растровые данные<a class="anchor" aria-label="anchor" href="#raster_data_r"><i class="fas fa-link"></i></a>
</h2>
<p>Работа с растровыми данными в целом гораздо проще, чем работа с векторными объектами. Это обусловлено в том числе жесткой сеточной структурой данных, которая предоставляет не так много свободы в различных сценариях обработки данных. В то же время, эта жесткая структура позволяет сделать растровые алгоритмы универсальными и робастными, многие задачи решаются в растровом виде быстрее и проще, чем в векторном.</p>
<p>В настоящее время для работы с растровыми данными в R наиболее часто используются два пакета: <a href="https://cran.r-project.org/web/packages/raster/index.html"><strong>raster</strong></a> и <a href="https://r-spatial.github.io/stars/"><strong>stars</strong></a>. Первый пакет исторически является основным средством работы с растровыми данными и обладает широким спектром функций растрового анализа. Второй пакет — относительно новый, разработан с целю поддержки многомерных данных и более тесного взаимодействия с пакетом <code>sf</code>.</p>
<div id="raster_read" class="section level3" number="10.5.1">
<h3>
<span class="header-section-number">10.5.1</span> Чтение<a class="anchor" aria-label="anchor" href="#raster_read"><i class="fas fa-link"></i></a>
</h3>
<p>Для чтения одноканальных растров (например, цифровых моделей рельефа или полей распределения метеорологических величин) используется функция <code><a href="https://rdrr.io/pkg/raster/man/raster.html">raster()</a></code>, она создает <em>растровый слой</em> (Raster Layer). Многоканальные растры (например, космические снимки или файлы NetCDF) читаются с помощью функции <code><a href="https://rdrr.io/pkg/raster/man/stack.html">stack()</a></code>, она создает <em>растровый стек</em> (Raster Stack):</p>
<div class="sourceCode" id="cb486"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>

<span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/gebco.tif'</span><span class="op">)</span> <span class="co"># Цифровая модель рельефа</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span>
<span class="co">## [1] "RasterLayer"</span>
<span class="co">## attr(,"package")</span>
<span class="co">## [1] "raster"</span>

<span class="va">img</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="st">'data/world/BlueMarbleJuly.tif'</span><span class="op">)</span> <span class="co"># Цветной космический снимок (RGB)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
<span class="co">## [1] "RasterStack"</span>
<span class="co">## attr(,"package")</span>
<span class="co">## [1] "raster"</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">img</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">## [1] "RasterLayer"</span>
<span class="co">## attr(,"package")</span>
<span class="co">## [1] "raster"</span></code></pre></div>
<p>Вы также можете прочитать каналы многоканального растра по отдельности. Для этого необходимо использовать функцию <code><a href="https://rdrr.io/pkg/raster/man/raster.html">raster()</a></code>, указав ей в качестве второго параметра номер канала, который вы хотите прочитать. Если потом потребуется собрать поканальные растры в один стек, для этого можно снова использовать функцию <code><a href="https://rdrr.io/pkg/raster/man/stack.html">stack()</a></code>:</p>
<div class="sourceCode" id="cb487"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ch1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/BlueMarbleJuly.tif'</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">ch2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/BlueMarbleJuly.tif'</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">ch3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/BlueMarbleJuly.tif'</span>, <span class="fl">3</span><span class="op">)</span>

<span class="va">img</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">ch1</span>, <span class="va">ch2</span>, <span class="va">ch3</span><span class="op">)</span></code></pre></div>
</div>
<div id="raster_viz" class="section level3" number="10.5.2">
<h3>
<span class="header-section-number">10.5.2</span> Визуализация<a class="anchor" aria-label="anchor" href="#raster_viz"><i class="fas fa-link"></i></a>
</h3>
<div id="raster_viz_single" class="section level4" number="10.5.2.1">
<h4>
<span class="header-section-number">10.5.2.1</span> Одноканальные растры<a class="anchor" aria-label="anchor" href="#raster_viz_single"><i class="fas fa-link"></i></a>
</h4>
<p>Для визуализации одноканальных растров используется функция <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code>. В простейшем виде ей достаточно просто передать визуализируемый растр:</p>
<div class="sourceCode" id="cb488"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-59-1.png" width="100%"></div>
<p>Поскольку растры часто используют в классифицированном виде, вы можете сформировать вектор граничных значений классов, вектор цветов классов, и передать их в параметры <code>breaks</code> и <code>col</code> функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> соответственно. Если параметр <code>breaks</code> не определять, то весь диапазон значений растра будет разбит на равные интервалы соответственно количеству цветов. Если не определять параметр <code>col</code>, то будет применена стандартная палитра <code>terrain.colors</code>. Вы также можете использовать одну из готовых палитр цветов или создать ее вручную (см. посвященную графической подсистеме R):</p>
<div class="sourceCode" id="cb489"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">brks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">12000</span>, <span class="fl">0</span>, <span class="fl">200</span>, <span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, <span class="fl">4000</span>, <span class="fl">8000</span><span class="op">)</span>
<span class="va">clrs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"steelblue4"</span>,
  <span class="st">"darkseagreen"</span>,
  <span class="st">"lightgoldenrod1"</span>,
  <span class="st">"darkgoldenrod1"</span>,
  <span class="st">"darkorange"</span>,
  <span class="st">"coral2"</span>,
  <span class="st">"firebrick3"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dem</span>, breaks <span class="op">=</span> <span class="va">brks</span>, col <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-60-1.png" width="100%"></div>
<div class="sourceCode" id="cb490"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ch1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-60-2.png" width="100%"></div>
<div class="sourceCode" id="cb491"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ch1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-60-3.png" width="100%"></div>
</div>
<div id="raster_viz_multi" class="section level4" number="10.5.2.2">
<h4>
<span class="header-section-number">10.5.2.2</span> Многоканальные растры<a class="anchor" aria-label="anchor" href="#raster_viz_multi"><i class="fas fa-link"></i></a>
</h4>
<p>Для визуализации растрового стека (многоканального растра) следует использовать функцию <code>plotRBG()</code>:</p>
<div class="sourceCode" id="cb492"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-61-1.png" width="100%"></div>
<p>Поскольку при визуализации космических снимков часто используют различные варианты синтеза каналов (чтобы лучше дешифрировать те или иные категории объектов), функция <code><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB()</a></code> предоставляет такую возможность. Достаточно перечислить последовательность каналов растрового стека (по умолчанию эти каналы будут подставлены в каналы R, G и B соответственно):</p>
<div class="sourceCode" id="cb493"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-62-1.png" width="100%"></div>
<div class="sourceCode" id="cb494"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="raster_combine" class="section level4" number="10.5.2.3">
<h4>
<span class="header-section-number">10.5.2.3</span> Совмещение слоев<a class="anchor" aria-label="anchor" href="#raster_combine"><i class="fas fa-link"></i></a>
</h4>
<p>Вы можете совмещать на картах несколько растровых и векторных слоев точно так же как и при совмещении векторных данных (указав параметр <code>add = TRUE</code> при вызове функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code>):</p>
<div class="sourceCode" id="cb495"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, border <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-63-1.png" width="100%"></div>
</div>
</div>
<div id="raster_proj" class="section level3" number="10.5.3">
<h3>
<span class="header-section-number">10.5.3</span> Системы координат и проекции<a class="anchor" aria-label="anchor" href="#raster_proj"><i class="fas fa-link"></i></a>
</h3>
<p>Как и в случае с векторными данными, работа с проекцией растровых данных предполагает четыре возможных процедуры: чтение, создание, замена и проецирование. Для чтения и замены информации о системе координат растра используется функция <code><a href="https://rdrr.io/pkg/raster/man/projection.html">crs()</a></code>. Она возвращает и принимает строку в формате <em>PROJ.4</em>. Для создания информации о системе координат можно использовать уже знакомую нам функцию <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code> из пакета <code>sf</code>. Данная функция возвращает список, вторая компонента которого и есть искомая строка:</p>
<div class="sourceCode" id="cb496"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="co"># читаем систему координат</span>
<span class="co">## CRS arguments: +proj=longlat +datum=WGS84 +no_defs</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">=</span> <span class="cn">NA</span> <span class="co"># очищаем систему координат</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span>
<span class="co">## CRS arguments: NA</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="co"># создаем систему координат</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span>
<span class="co">## CRS arguments: +proj=longlat +datum=WGS84 +no_defs</span></code></pre></div>
<p>Для проецирования растра в новую систему координат необходимо использовать функцию <code><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">projectRaster()</a></code>. В эту функцию необходимо передать как минимум два параметра: <code>from=</code> отвечает за входной растр и <code>crs=</code> отвечает за выходную систему координат в формате PROJ.4. Дополнительно можно указать разрешение растра (<code>res=</code>), метод передискретизации (<code>method=</code>) и растр-шаблон (<code>to=</code> — можно создать растр в выходной системе координат заранее и как бы “перенести” значения пикселей входного растра на пиксели шаблона). Есть и другие параметры, с которыми можно ознакомиться в справке функции <code><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">projectRaster()</a></code>.</p>
<p>Приведем несколько примеров проецирования:</p>
<div class="sourceCode" id="cb497"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Проекция Меркатора:</span>
<span class="va">img.merc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">projectRaster</a></span><span class="op">(</span><span class="va">img</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img.merc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries.merc</span><span class="op">)</span>, 
     border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.2</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-65-1.png" width="100%"></div>
<div class="sourceCode" id="cb498"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Проекция Робинсона:</span>
<span class="va">img.merc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">projectRaster</a></span><span class="op">(</span><span class="va">img</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">'+proj=robin'</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plotRGB.html">plotRGB</a></span><span class="op">(</span><span class="va">img.merc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">countries.rob</span><span class="op">)</span>, 
     border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.2</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-66-1.png" width="100%"></div>
</div>
<div id="raster_values" class="section level3" number="10.5.4">
<h3>
<span class="header-section-number">10.5.4</span> Операции со значениями<a class="anchor" aria-label="anchor" href="#raster_values"><i class="fas fa-link"></i></a>
</h3>
<p>Операции со значениями растров чрезвычайно разнообразны, поэтому подробно они разбираются в одной из последующих глав. Здесь же мы кратко познакомимся с <em>локальными операциями</em> над растром, такими как фильтрация и арифметические преобразования. В локальных операциях каждый пиксел растра анализируется отдельно, независимо от остальных пикселов. Поэтому локальные операции наиболее просты в применении. Но это не означает, что они менее важны, чем более сложные операции. Как раз наоборот: фильтрация и арифметика представляют собой важнейшие операции растровой алгебры.</p>
<p>Особенность растровой алгебры заключается в том, что растры используются в выражениях как обычные переменные — это делает преобразования растров простыми и наглядными.</p>
<p>Чтобы произвести <strong>фильрацию</strong> (выбор) ячеек по значениям, необходимо соорудить логическое выражение с участием растра. Все пикселы, удовлетворяющие критерию, получат в результирующем растре значение <code>1</code>, а все остальные — <code>0</code>. Несколько примеров:</p>
<div class="sourceCode" id="cb499"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">below.zero</span> <span class="op">=</span> <span class="va">dem</span> <span class="op">&lt;</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">below.zero</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-67-1.png" width="100%"></div>
<div class="sourceCode" id="cb500"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">highlands</span> <span class="op">=</span> <span class="va">dem</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">&amp;</span> <span class="va">dem</span> <span class="op">&lt;</span> <span class="fl">500</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">highlands</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-67-2.png" width="100%"></div>
<div class="sourceCode" id="cb501"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">mountains</span> <span class="op">=</span> <span class="va">dem</span> <span class="op">&gt;</span> <span class="fl">1000</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">mountains</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-67-3.png" width="100%"></div>
<p>С помощью локальных операций растровой алгебры можно складывать, вычитать, перемножать и делить растры (а также брать из них квадратные корни, логарифмы, тригонометрические функции), точно так же как это происходит с обычными числами. Соответственно, бывают бинарные (два растра) и унарные (один растр) операции.</p>
<blockquote>
<p>Чтобы получать предсказуемые результаты бинарных операций растровой алгебры, необходимо, чтобы геометрия растров совпадала.</p>
</blockquote>
<p>Покажем возможности растровой алгебры на примере определения толщины покровного оледенения. Глобальная цифровая модель рельефа <a href="https://data.nodc.noaa.gov/cgi-bin/iso?id=gov.noaa.ngdc.mgg.dem:316">ETOPO1</a> поставляется в двух вариантах: Ice Surface (поверхность с учетом покровного оледенения) и Bedrock (подстилающая поверхность). Если вычесть из первой вторую, можно узнать толщину льда в Гренландии и на Антарктиде:</p>
<div class="sourceCode" id="cb502"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/etopo1_bed.tif'</span><span class="op">)</span>
<span class="va">ice</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/world/etopo1_ice.tif'</span><span class="op">)</span>

<span class="va">ice.depth</span> <span class="op">=</span> <span class="va">ice</span> <span class="op">-</span> <span class="va">bed</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ice.depth</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">cm.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, border <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-68-1.png" width="100%"></div>
<p>Чтобы маскировать значения растра, необходимо воспользоваться функцией <code><a href="https://rdrr.io/pkg/raster/man/getValues.html">values()</a></code>, которая обнажает список значений растра. Например, можно превратить в NA все пикселы, в которых толщина льда меньше или равна нулю:</p>
<div class="sourceCode" id="cb503"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ice.depth</span><span class="op">[</span><span class="va">ice.depth</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ice.depth</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">cm.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">outlines</span>, border <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-69-1.png" width="100%"></div>
</div>
<div id="raster_export" class="section level3" number="10.5.5">
<h3>
<span class="header-section-number">10.5.5</span> Экспорт<a class="anchor" aria-label="anchor" href="#raster_export"><i class="fas fa-link"></i></a>
</h3>
<p>Чтобы экспортировать (сохранить в файл) любой растр, можно воспользоваться функцией <code><a href="https://rdrr.io/pkg/raster/man/writeRaster.html">writeRaster()</a></code>, указав имя выходного файла:</p>
<div class="sourceCode" id="cb504"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/writeRaster.html">writeRaster</a></span><span class="op">(</span><span class="va">ice.depth</span>, <span class="st">'data/world/ice_depth.tif'</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="spatial_ggplot2" class="section level2" number="10.6">
<h2>
<span class="header-section-number">10.6</span> Визуализация средствами ggplot2<a class="anchor" aria-label="anchor" href="#spatial_ggplot2"><i class="fas fa-link"></i></a>
</h2>
<p>Пространственные данные поддерживаются в графической подсистеме ggplot2. Для этого <a href="https://ggplot2.tidyverse.org/reference/ggsf.html">существует</a> несколько специализированных функций:</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> вызывает <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">stat_sf()</a></code> и <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> того чтобы отобразить пространственные данные в нужной системе координат;</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> обеспечивает поддержку картографических проекций и позволяет отображать данные в нужной системе координат на лету;</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">stat_sf()</a></code> отвечает за отображение переменных данных на графические переменные для пространственных данных;</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label()</a></code> позволяет отображать подписи объектов на плашке;</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text()</a></code> позволяет размещзать подписи объектов без плашки.</li>
</ul>
<p>Отобразим для примера границы России в конической проекции:</p>
<div class="sourceCode" id="cb505"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">russia</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">countries</span>, <span class="va">adm0_a3</span> <span class="op">==</span> <span class="st">'RUS'</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">russia</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">'+proj=eqdc +lon_0=100 +lat_1=42 +lat_2=60 +datum=WGS84 +units=m'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">180</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-71-1.png" width="100%"></div>
<p>Так же как ив случае стандартной подсистемы, можно указать атрибутивное поле, по которому будет строиться тематическая карта. Покажем это на примере выгруженных ранее Европейских стран:</p>
<div class="sourceCode" id="cb506"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">brks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">nbrks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">brks</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">europe.conic</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="va">gdp_md_est</span><span class="op">/</span><span class="va">pop_est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>
      colours <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">'RdYlGn'</span><span class="op">)</span>, 
      breaks <span class="op">=</span> <span class="va">brks</span>,
      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">brks</span><span class="op">[</span><span class="op">-</span><span class="va">nbrks</span><span class="op">]</span><span class="op">)</span>, <span class="st">'-'</span>, <span class="va">brks</span><span class="op">)</span>,
      guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>keyheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Валовый внутренний продукт'</span>, fill <span class="op">=</span> <span class="st">'\n$ тыс/чел.'</span> <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10-SpatialData_files/figure-html/unnamed-chunk-72-1.png" width="100%"></div>
</div>
<div id="spatial_interactive" class="section level2" number="10.7">
<h2>
<span class="header-section-number">10.7</span> Интерактивные карты<a class="anchor" aria-label="anchor" href="#spatial_interactive"><i class="fas fa-link"></i></a>
</h2>
<p>R предоставляет возможности для интерактивного просмотра пространственных данных средствами библиотек веб-картографирования. В данном разделе мы кратко познакомимся с возможностями пакета <a href="https://r-spatial.github.io/mapview/"><strong>mapview</strong></a>, который использует возможности библиотеки <a href="https://leafletjs.com/">Leaflet</a>. Функции данного пакета не предназначены для создания тематических карт высокого качества и рассчитаны на выполнение исследовательского анализа данных.</p>
<p>Чтобы отобразить векторный или растровый слой средствами mapview, достаточно вызвать одноименную функцию данного пакета:</p>
<div class="sourceCode" id="cb507"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">sf_stations</span><span class="op">)</span></code></pre></div>
<p>Чтобы скомбинировать несколько слоев, необходимо сложить несколько вызовов <code><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview()</a></code>:</p>
<div class="sourceCode" id="cb508"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">countries</span>, col.regions <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">sf_stations</span>, col.regions <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></code></pre></div>
</div>
<div id="questions_tasks_spatial" class="section level2" number="10.8">
<h2>
<span class="header-section-number">10.8</span> Контрольные вопросы и упражнения<a class="anchor" aria-label="anchor" href="#questions_tasks_spatial"><i class="fas fa-link"></i></a>
</h2>
<div id="questions_spatial" class="section level3" number="10.8.1">
<h3>
<span class="header-section-number">10.8.1</span> Вопросы<a class="anchor" aria-label="anchor" href="#questions_spatial"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Что такое пространственные данные и какие модели пространственных данных существуют?</li>
<li>Назовите номер стандарта ISO, в котором описана модель <em>Simple Features</em>.</li>
<li>Перечислите основные принципы представления объектов в рамках стандарта <em>Simple Features</em>.</li>
<li>Какие размерности координат допустимы в объектах <em>Simple Features</em>?</li>
<li>Перечислите основные 7 типов геометрий. Сколько всего их описано в стандарте <em>Simple Features</em>?</li>
<li>Как называются основные два формата представления объектов <em>Simple Features</em>?</li>
<li>Перечислите основные компоненты пространственной привязки.</li>
<li>Перечислите основные форматы описания пространственной привязки.</li>
<li>Дайте расшифровку основных параметров строки <em>PROJ.4</em>.</li>
<li>Какой номер <em>EPSG</em> имеет географическая система координат <em>WGS84</em>?</li>
<li>В чем отличие трансформирования координат и проецирования?</li>
<li>Какие три программных библиотеки составляют основу функциональности пакета <strong>sf</strong>? Каково их назначение?</li>
<li>В чем отличие объектов типа <strong>sp</strong> от <strong>sf</strong>?</li>
<li>Что означает префикс <code>st_</code>, используемый в названиях функций пакета <strong>sf</strong>?</li>
<li>Какая функция используется для чтения данных средствами пакета <strong>sf</strong>?</li>
<li>Перечислите три класса, слагающих иерархию представления пространственных объектов, реализуемую пакетом <strong>sf</strong>.</li>
<li>Какой тип данных имеет колонка с геометрией объекта <strong>sf</strong>?</li>
<li>Какая функция позволяет извлечь геометрическую колонку из объекта <strong>sf</strong>?</li>
<li>С помощью какой структуры данных фактически реализован класс объектов <strong>sfg</strong>?</li>
<li>Сколько карт будет построено функцией <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> применительно к объекту <strong>sf</strong>?</li>
<li>Как с помощью функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> нарисовать только геометрию объектов, не отображая атрибутивные характеристики?</li>
<li>Какой параметр функции <code><a href="https://rdrr.io/pkg/raster/man/plot.html">plot()</a></code> отвечает за отображение/не отображение градусной сетки координат?</li>
<li>Каким способом можно узнать и задать систему координат объекта <strong>sf</strong>?</li>
<li>Какая функция позволяет осуществить проецирование данных?</li>
<li>Можно ли применять к объектам типа <strong>sf</strong> стандартные манипуляции <strong>dplyr</strong>?</li>
<li>Что произойдет с геометрией пространственных объектов при выполнении агрегирования данных по группам значений заданных атрибутов?</li>
<li>Перечислите 8 вариантов топологических отношений и названий функций <strong>sf</strong>, которые им соответствуют.</li>
<li>Опишите способ, с помощью которого можно выбрать пространственные объекты, пересекающиеся с заданным множеством пространственных объектов.</li>
<li>Каким образом можно заменить тип топологического отношения с пересечения на любой другой при выполнении пространственной выборки?</li>
<li>Перечислите функции, с помощью которых создаются объекты типа <strong>sfg</strong>, и структуры данных с координатами, которые должны быть поданы на вход этих функций.</li>
<li>Назовите три правила, которым подчиняется формат представления координат вершин <em>полигональных</em> объектов.</li>
<li>Может ли обычный полигон <strong>sf</strong> содержать дырку, или же для этого требуется создание мультиполигона?</li>
<li>Как можно быстро собрать слой точечных объектов по их координатам, не собирая объекты вручную?</li>
<li>Какая функция позволяет осуществлять преобразование типа геометрии <strong>sf</strong>?</li>
<li>Перечислите требования, которым должно удовлетворять множество линейных объектов для того, чтобы к нему была применима операция полигонизации?</li>
<li>Назовите функции <strong>sf</strong>, реализующие операцию добавления вершин в точках пересечения линий и операцию полигонизации линий.</li>
<li>Перечислите названия функций <strong>sf</strong>, позволяющих получать ограничивающий прямоугольник, периметр, площадь, центроид, характерную точку и координаты объекта.</li>
<li>С помощью какой функции осуществляется запись (экспорт) <strong>sf</strong> в файлы пространственных данных?</li>
<li>Назовите основные параметры, определяющие геометрию растра.</li>
<li>Какой пакет отвечает за поддержку растровых данных в <strong>R</strong>?</li>
<li>Как можно прочитать одноканальный и многоканальный растры в <strong>R</strong>? В чем отличие этих случаев?</li>
<li>Какие функции можно использовать для визуализации одноканальных и многоканальных растров?</li>
<li>Можно ли совмещать растровые и векторные слои на одном изображении? Если да, то как эта возможность реализуется?</li>
<li>Каким образом можно узнать и задать пространственную привязку растрового набора данных?</li>
<li>Какая функция отвечает за проецирование растровых данных? Перечислите ее параметры и их назначение.</li>
<li>Опишите способ, с помощью которого можно осуществить фильтрацию растра (превратить его в растр TRUE/FALSE) и маскирование растра (заменить ненужные ячейки на NA).</li>
<li>С помощью какой функции пакета <strong>raster</strong> можно осуществить экспорт растра в файл?</li>
<li>Назовите пакет (и одноименную функцию), с помощью которых можно быстро осуществлять интерактивный просмотр пространственных данных.</li>
</ol>
</div>
<div id="tasks_spatial" class="section level3" number="10.8.2">
<h3>
<span class="header-section-number">10.8.2</span> Упражнения<a class="anchor" aria-label="anchor" href="#tasks_spatial"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Преобразуйте точки землетрясений из набора данных <em>quakes</em> в пространственные объекты и отобразите их сначала средствами стандартной графической подсистемы, а затем на интерактивной карте средствами пакета <strong>mapview</strong>. Передайте магнитуду землетрясения в параметр <code>zcol</code> функции <code><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview()</a></code>, чтобы дифференцировать точки цветом по этому параметру.</p></li>
<li><p>Таблица <em>storms</em> из пакета <strong>dplyr</strong> содержит данные трекинга тропических циклонов c 1975 по 2015 год. Выберите любой циклон и постройте для него линию трека прохождения и точки прохождения. Отобразите эти данные средствами <strong>ggplot2</strong>, а затем на интерактивной карте средствами <strong>mapview</strong>. Напишите программу таким образом, чтобы можно было выбирать имя циклона и программа отображала его трек на интерактивной карте.</p></li>
<li><p>Скачайте <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino.gpkg">базу данных</a> и <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino_DEM.zip">цифровую модель рельефа</a> на территорию Сатинского полигона МГУ. Изучите содержимое базы данных и постройте на основе этих данных общегеографическую карту средствами стандартной графической подсистемы, а затем средствами <strong>ggplot2</strong>.</p></li>
</ol>
<div class="inline-table"><table class="table table-sm"><tbody><tr class="odd">
<td>
<em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, 2021. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a>
</td>
</tr></tbody></table></div>
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="circular.html"><span class="header-section-number">9</span> Дирекционные данные</a></div>
<div class="next"><a href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatial"><span class="header-section-number">10</span> Пространственные данные</a></li>
<li><a class="nav-link" href="#spatial_prerequisites"><span class="header-section-number">10.1</span> Предварительные требования</a></li>
<li>
<a class="nav-link" href="#spatial_models"><span class="header-section-number">10.2</span> Модели пространственных данных</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simple_features"><span class="header-section-number">10.2.1</span> Векторные данные</a></li>
<li><a class="nav-link" href="#raster_data"><span class="header-section-number">10.2.2</span> Растровые данные</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#spatref"><span class="header-section-number">10.3</span> Пространственная привязка</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatref_components"><span class="header-section-number">10.3.1</span> Компоненты пространственной привязки</a></li>
<li><a class="nav-link" href="#spatref_formats"><span class="header-section-number">10.3.2</span> Форматы описания пространственной привязки</a></li>
<li><a class="nav-link" href="#spatref_transform"><span class="header-section-number">10.3.3</span> Преобразование координат</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#vector_data_r"><span class="header-section-number">10.4</span> Векторные данные</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vector_data_packages"><span class="header-section-number">10.4.1</span> Базовые библиотеки</a></li>
<li><a class="nav-link" href="#vector_data_reading"><span class="header-section-number">10.4.2</span> Чтение</a></li>
<li><a class="nav-link" href="#sf_structure"><span class="header-section-number">10.4.3</span> Внутренняя структура</a></li>
<li><a class="nav-link" href="#sf_plotting"><span class="header-section-number">10.4.4</span> Визуализация</a></li>
<li><a class="nav-link" href="#sf_crs"><span class="header-section-number">10.4.5</span> Системы координат и проекции</a></li>
<li><a class="nav-link" href="#sf_attrs"><span class="header-section-number">10.4.6</span> Атрибутивные операции</a></li>
<li><a class="nav-link" href="#sf_spat_selection"><span class="header-section-number">10.4.7</span> Пространственные операции</a></li>
<li><a class="nav-link" href="#sf_creation"><span class="header-section-number">10.4.8</span> Создание пространственных объектов</a></li>
<li><a class="nav-link" href="#sf_geom_attrs"><span class="header-section-number">10.4.9</span> Геометрические атрибуты</a></li>
<li><a class="nav-link" href="#sf_export"><span class="header-section-number">10.4.10</span> Экспорт</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#raster_data_r"><span class="header-section-number">10.5</span> Растровые данные</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#raster_read"><span class="header-section-number">10.5.1</span> Чтение</a></li>
<li><a class="nav-link" href="#raster_viz"><span class="header-section-number">10.5.2</span> Визуализация</a></li>
<li><a class="nav-link" href="#raster_proj"><span class="header-section-number">10.5.3</span> Системы координат и проекции</a></li>
<li><a class="nav-link" href="#raster_values"><span class="header-section-number">10.5.4</span> Операции со значениями</a></li>
<li><a class="nav-link" href="#raster_export"><span class="header-section-number">10.5.5</span> Экспорт</a></li>
</ul>
</li>
<li><a class="nav-link" href="#spatial_ggplot2"><span class="header-section-number">10.6</span> Визуализация средствами ggplot2</a></li>
<li><a class="nav-link" href="#spatial_interactive"><span class="header-section-number">10.7</span> Интерактивные карты</a></li>
<li>
<a class="nav-link" href="#questions_tasks_spatial"><span class="header-section-number">10.8</span> Контрольные вопросы и упражнения</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#questions_spatial"><span class="header-section-number">10.8.1</span> Вопросы</a></li>
<li><a class="nav-link" href="#tasks_spatial"><span class="header-section-number">10.8.2</span> Упражнения</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tsamsonov/r-geo-course/blob/master/10-SpatialData.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tsamsonov/r-geo-course/edit/master/10-SpatialData.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Визуализация и анализ географических данных на языке R</strong>" was written by Тимофей Самсонов. It was last built on 2021-01-27.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
